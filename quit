[1mdiff --git a/ad b/ad[m
[1mdeleted file mode 100644[m
[1mindex 9b7dee2..0000000[m
[1m--- a/ad[m
[1m+++ /dev/null[m
[36m@@ -1,765 +0,0 @@[m
[31m-[1mdiff --git a/industry_alert/account/models.py b/industry_alert/account/models.py[m[m
[31m-[1mindex 71a8362..ec96231 100755[m[m
[31m-[1m--- a/industry_alert/account/models.py[m[m
[31m-[1m+++ b/industry_alert/account/models.py[m[m
[31m-[36m@@ -1,3 +1,65 @@[m[m
[31m- from django.db import models[m[m
[31m-[32m+[m[32mfrom django.contrib.auth.base_user import BaseUserManager, AbstractBaseUser[m[m
[31m-[32m+[m[32mfrom django.contrib.auth.models import PermissionsMixin[m[m
[31m- [m[m
[31m-[31m-# Create your models here.[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m# https://docs.djangoproject.com/en/3.2/ref/contrib/auth/[m[m
[31m-[32m+[m[32mclass AccountManager(BaseUserManager):[m[m
[31m-[32m+[m[32m    def create_user(self, email, password, name):[m[m
[31m-[32m+[m[32m        if not email:[m[m
[31m-[32m+[m[32m            raise ValueError('Users must have an email address')[m[m
[31m-[32m+[m[32m        print('ì–´ì¹´ìš´íŠ¸')[m[m
[31m-[32m+[m[32m        # ì´ê±° ê·¼ë° ê¼­ í•´ì•¼í•˜ëŠ”ê±´ì§€ëŠ” ëª¨ë¥´ê² ìŒ[m[m
[31m-[32m+[m[32m        user = self.model([m[m
[31m-[32m+[m[32m            # normalize_email()ì´ê±°ëŠ” @domainì—ì„œ domainë§Œ ì†Œë¬¸ìë¡œ ë§Œë“¬[m[m
[31m-[32m+[m[32m            email=self.normalize_email(email),[m[m
[31m-[32m+[m[32m            name=name[m[m
[31m-[32m+[m[32m        )[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m        # Sets the userâ€™s password to the given raw string,[m[m
[31m-[32m+[m[32m        # taking care of the password hashing. Doesnâ€™t save the User object.[m[m
[31m-[32m+[m[32m        user.set_password(password)[m[m
[31m-[32m+[m[32m        user.save()[m[m
[31m-[32m+[m[32m        return user[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    def create_superuser(self, email, password, name):[m[m
[31m-[32m+[m[32m        user = self.create_user([m[m
[31m-[32m+[m[32m            email=self.normalize_email(email),[m[m
[31m-[32m+[m[32m            password=password,[m[m
[31m-[32m+[m[32m            name=name[m[m
[31m-[32m+[m[32m        )[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m        # https://docs.djangoproject.com/en/3.2/ref/contrib/auth/[m[m
[31m-[32m+[m[32m        user.is_admin = True[m[m
[31m-[32m+[m[32m        user.is_active = True[m[m
[31m-[32m+[m[32m        user.is_superuser = True[m[m
[31m-[32m+[m[32m        user.save()[m[m
[31m-[32m+[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m# drf login[m[m
[31m-[32m+[m[32m# https://medium.com/geekculture/register-login-and-logout-users-in-django-rest-framework-51486390c29[m[m
[31m-[32m+[m[32m# https://github.com/django/django/blob/910ecd1b8df7678f45c3d507dde6bcb1faafa243/django/contrib/auth/base_user.py#L16 ì°¸ì¡°í•˜ê¸°[m[m
[31m-[32m+[m[32m# ì—¬ê¸°ì— ì´ë¦„ ìƒë…„ì›”ì¼ ì „í™”ë²ˆí˜¸ ê°™ì€ ê±° ë” ì¶”ê°€í•˜ê¸°[m[m
[31m-[32m+[m[32mclass User(AbstractBaseUser, PermissionsMixin):[m[m
[31m-[32m+[m[32m    email = models.EmailField(verbose_name="email", max_length=60, unique=True, default=None)[m[m
[31m-[32m+[m[32m    password = models.CharField(verbose_name='password', max_length=255)[m[m
[31m-[32m+[m[32m    # charfieldëŠ” null trueí•˜ëŠ”ê±°ì•„ë‹˜ ê°’ì´ ë¹„ì–´ìˆë‹¤ë¥¼ í‘œì‹œí•˜ëŠ”ê²Œ ë¹ˆìŠ¤íŠ¸ë§ì´ë‘ null ë‘ê°€ì§€ê°€ ë‹¤ë˜ë©´ì„œ ê³±ì°½ë‚¨[m[m
[31m-[32m+[m[32m    name = models.CharField(verbose_name='name', max_length=30, default='', blank=True)[m[m
[31m-[32m+[m[32m    is_admin = models.BooleanField(default=False)[m[m
[31m-[32m+[m[32m    is_superuser = models.BooleanField(default=False)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # usernameìœ¼ë¡œ 'email' field ì‚¬ìš©í•¨[m[m
[31m-[32m+[m[32m    USERNAME_FIELD = 'email'[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # superuser ìƒì„±ì‹œ ì¶”ê°€ë¡œ ë°›ì„ê±°[m[m
[31m-[32m+[m[32m    # https://docs.djangoproject.com/en/3.2/topics/auth/customizing/[m[m
[31m-[32m+[m[32m    REQUIRED_FIELDS = ['name'][m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    objects = AccountManager()[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    @property[m[m
[31m-[32m+[m[32m    def is_staff(self):[m[m
[31m-[32m+[m[32m        return self.is_admin[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    def __str__(self):[m[m
[31m-[32m+[m[32m        return str(self.email)[m[m
[31m-\ No newline at end of file[m[m
[31m-[1mdiff --git a/industry_alert/account/serializers.py b/industry_alert/account/serializers.py[m[m
[31m-[1mindex e69de29..2d98842 100644[m[m
[31m-[1m--- a/industry_alert/account/serializers.py[m[m
[31m-[1m+++ b/industry_alert/account/serializers.py[m[m
[31m-[36m@@ -0,0 +1,105 @@[m[m
[31m-[32m+[m[32mfrom rest_framework import serializers[m[m
[31m-[32m+[m[32mfrom .models import User[m[m
[31m-[32m+[m[32mfrom django.contrib.auth import get_user_model[m[m
[31m-[32m+[m[32mfrom rest_framework.authtoken.models import Token[m[m
[31m-[32m+[m[32m# get_user_model() : í´ë˜ìŠ¤ì´ë‹¤.[m[m
[31m-[32m+[m[32m# >>> get_user_model()[m[m
[31m-[32m+[m[32m# <class 'accounts.models.User'>[m[m
[31m-[32m+[m[32m# settings.AUTH_USER_MODEL : ë¬¸ìì—´ì´ë‹¤.[m[m
[31m-[32m+[m[32m# >>> settings.AUTH_USER_MODEL[m[m
[31m-[32m+[m[32m# >>> settings.AUTH_USER_MODEL[m[m
[31m-[32m+[m[32m# 'accounts.User'[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m# exceptions[m[m
[31m-[32m+[m[32mclass InvalidPassword(Exception):[m[m
[31m-[32m+[m[32m    pass[m[m
[31m-[32m+[m[32m# drf[m[m
[31m-[32m+[m[32m# 1. Serializerë¥¼ ìƒì†ë°›ì€ LoginSerializer, ê·¸ë¦¬ê³  ModelSerializerë¥¼ ìƒì†ë°›ì€ UserSerializer ë‘ ê°œ ì‘ì„±[m[m
[31m-[32m+[m[32m# 2. ê° serializerëŠ” ì•„ë˜ì™€ ê°™ì€ fieldë¥¼ ê°€ì§€ê³  ì´ë¦„ì— ë§ëŠ” ë™ì‘ì„ í•´ì•¼í•¨[m[m
[31m-[32m+[m[32m# https://eunjin3786.tistory.com/253[m[m
[31m-[32m+[m[32m# LoginSerializer[m[m
[31m-[32m+[m[32m#     ì“°ê¸°ì „ìš© : username, password[m[m
[31m-[32m+[m[32m#     ì½ê¸°ì „ìš© : token[m[m
[31m-[32m+[m[32m#     ë™ì‘ : usernameê³¼ passwordë¡œ userì¸ì¦ì„ í•˜ê³ , userì˜ tokenì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„, ì—†ìœ¼ë©´ ìƒˆë¡œ ë°œí–‰í•´ì„œ ëŒë ¤ì¤Œ[m[m
[31m-[32m+[m[32mclass LoginSerializer(serializers.Serializer):[m[m
[31m-[32m+[m[32m    # write_onlyëŠ” ê°’ì„ ë°›ì•„ì„œ create/updateê°™ì€ê±°ë§Œ í•˜ëŠ”ê±°ì„[m[m
[31m-[32m+[m[32m    email = serializers.CharField(write_only=True)[m[m
[31m-[32m+[m[32m    password = serializers.CharField(write_only=True)[m[m
[31m-[32m+[m[32m    # ì…ë ¥ë°›ëŠ”ê²Œ ì•„ë‹ˆë¼ returnìœ¼ë¡œ ëŒë ¤ì£¼ëŠ” ê°’ì´ë‹ˆê¹Œ read_onlyì„[m[m
[31m-[32m+[m[32m    token = serializers.CharField(read_only=True)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # ë¡œê·¸ì¸ í™•ì¸[m[m
[31m-[32m+[m[32m    def create(self, validated_data):[m[m
[31m-[32m+[m[32m        email = validated_data['email'][m[m
[31m-[32m+[m[32m        password = validated_data['password'][m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m        user = User.objects.get(email=email)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m        # ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜í•˜ë©´[m[m
[31m-[32m+[m[32m        if user.check_password(password):[m[m
[31m-[32m+[m[32m            token, _ = Token.objects.get_or_create(user=user)[m[m
[31m-[32m+[m[32m            # ì´ê±° ê·¸ëƒ¥ return token í•˜ë©´ ì•ˆë¼ëŠ” ì´ìœ ëŠ”[m[m
[31m-[32m+[m[32m            # ë°‘ì˜ ìœ ì €ì‹œë¦¬ì–¼ë¼ì´ì €ì—ì„œëŠ” user.tokenì— token.keyë¥¼ ë„£ì–´ì¤¬ëŠ”ë°[m[m
[31m-[32m+[m[32m            # ì´ê±° ë¦¬í„´ë˜ëŠ” objectì—ì„œ getattrë¡œ ë¦¬í„´ fieldë“¤ì´ ë‹¤ ìˆìœ¼ë©´ ì•Œì•„ì„œ ë§Œë“¤ì–´ì£¼ëŠ”ê±´ë°[m[m
[31m-[32m+[m[32m            # ë°‘ì—ì„œëŠ” ë¦¬í„´ì´ userê°ì²´ì˜€ê³  ì´ ê°ì²´ì—ëŠ” class Metaì— ìˆëŠ” 3ê°œì˜ fieldê°€ ë‹¤ ìˆì–´ì„œ ë¬¸ì œì—†ì´ ëœê±°ê³ [m[m
[31m-[32m+[m[32m            # ì§€ê¸ˆì€ tokenì„ ë¦¬í„´í•˜ê²Œ ë˜ë©´ token.tokenì€ ì—†ê³  token.keyì— ì›í•˜ëŠ”ê°’ì´ìˆì§€[m[m
[31m-[32m+[m[32m            # ê·¸ë˜ì„œ ì§€ê¸ˆ ì—ëŸ¬ì¸ {}ê°€ ê°€ëŠ”ê±°ì„[m[m
[31m-[32m+[m[32m            # tokenì„ ë¦¬í„´í•˜ë©´ Token objectì¸ë° ë‚´ê°€ serializerì— ë¦¬í„´í•˜ê² ë‹¤ê³  ëª…ì‹œí•œê±´[m[m
[31m-[32m+[m[32m            # tokenì´ë¼ëŠ” í•„ë“œê³  ë¦¬í„´í•œê±¸ serializeí–ˆì„ë•Œ ë¦¬í„´ ê²°ê³¼ë¬¼ì— tokenì´ë¼ëŠ” attributeê°€ ìˆì–´ì•¼í•˜ëŠ”ë°[m[m
[31m-[32m+[m[32m            # token.tokenì´ ì—†ìœ¼ë‹ˆ ì•„ë¬´ëŸ° ê²°ê³¼ë¬¼ì´ ì•ˆë‚˜ì˜¤ëŠ”ê±°ì„[m[m
[31m-[32m+[m[32m            # ì´ì œ {'token': token.key}ë¥¼ ë¦¬í„´í•˜ë©´ getattr(ë¦¬í„´ ê²°ê³¼ë¬¼, 'token')í•˜ë©´[m[m
[31m-[32m+[m[32m            # ê°’ì´ ìˆìœ¼ë‹ˆ ê²°ê³¼ë¬¼ì´ ë‚˜ì˜¤ëŠ”ê±°ì„[m[m
[31m-[32m+[m[32m            # ê°ì²´ serializeí•˜ë©´ __str__()ë¡œ ë‚˜ì˜¤ëŠ” ê²°ê³¼ë¬¼ì´ ë‚˜ì˜´[m[m
[31m-[32m+[m[32m            # print(getattr(token, 'key'))[m[m
[31m-[32m+[m[32m            print(token.key)[m[m
[31m-[32m+[m[32m            return {'token': token.key}[m[m
[31m-[32m+[m[32m        # ì¼ì¹˜í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´[m[m
[31m-[32m+[m[32m        raise InvalidPassword[m[m
[31m-[32m+[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m# UserSerializer[m[m
[31m-[32m+[m[32m#     ë‘˜ ë‹¤ : í•„ìš”í•œ ëª¨ë“  ìœ ì €ì •ë³´ë“¤[m[m
[31m-[32m+[m[32m#     ì“°ê¸°ì „ìš© : password[m[m
[31m-[32m+[m[32m#     ì½ê¸°ì „ìš© : token[m[m
[31m-[32m+[m[32m#     ë™ì‘ : ë°›ì€ userì •ë³´ë¥¼ í†µí•´ Userë¥¼ ìƒì„±í•˜ê³ , ìƒì„±ëœ userì˜ tokenì„ ìƒˆë¡œ ë°œí–‰í•´ì„œ passwordë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì •ë³´ì™€ í•¨ê»˜ ëŒë ¤ì¤Œ[m[m
[31m-[32m+[m[32mclass UserSerializer(serializers.ModelSerializer):[m[m
[31m-[32m+[m[32m    password = serializers.CharField(write_only=True)[m[m
[31m-[32m+[m[32m    token = serializers.CharField(read_only=True)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    class Meta:[m[m
[31m-[32m+[m[32m        model = get_user_model()[m[m
[31m-[32m+[m[32m        fields = ['email', 'password', 'name', 'token'][m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # ì´ê±° ê·¼ë° user.mode()ì—ì„œ í•´ì£¼ëŠ”ë° ì—†ì–´ì•¼í•˜ëŠ”ê±° ê°™ìŒ[m[m
[31m-[32m+[m[32m    # overrideí•˜ëŠ”ê±°ë‹ˆê¹Œ ì¸ì ë§ì¶°ì¤˜ì•¼í•¨[m[m
[31m-[32m+[m[32m    def create(self, validated_data):[m[m
[31m-[32m+[m[32m        print("ìœ ì €ì‹œë¦¬ì–¼ë¼ì´ì € - create")[m[m
[31m-[32m+[m[32m        # ì´ì œ ì´ validate_dataëŠ” validationë„ ëë‚¬ìœ¼ë‹ˆ ì •í•©í•œ ë°ì´í„°ë‹ˆ ê·¸ëƒ¥ ë•Œë ¤ë²„ë¦¬ë©´ ë¨[m[m
[31m-[32m+[m[32m        # ì´ê±° **ì€[m[m
[31m-[32m+[m[32m        # **d means "take all additional named arguments to this function[m[m
[31m-[32m+[m[32m        # and insert them into this parameter as dictionary entries."[m[m
[31m-[32m+[m[32m        # ì´ê±° create_userê°€ ì¸ìë¥¼ 2ê°œ ë°›ì•„ì•¼í•˜ë‹ˆ **validated_data[m[m
[31m-[32m+[m[32m        user = User.objects.create_user(**validated_data)[m[m
[31m-[32m+[m[32m        # ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒì„±í•œê°’ì´ë‘[m[m
[31m-[32m+[m[32m        # ìƒì„±ëëŠ”ì§€ ê°€ì ¸ì˜¨ê±´ì§€ ì—¬ë¶€ë¥¼[m[m
[31m-[32m+[m[32m        # íŠœí”Œë¡œì¤Œ[m[m
[31m-[32m+[m[32m        # ì €ê²Œ ìƒì„±ìœ¼ë¡œ ê°€ì ¸ì˜¨ ê²°ê³¼ë¬¼ì´ë©´ True[m[m
[31m-[32m+[m[32m        # ìˆë˜ê±° ê°€ì ¸ì˜¨ê±°ë©´ False[m[m
[31m-[32m+[m[32m        # _ëŠ” ì•ˆì“¸ê°’ì€ _ë¡œ ì €ì¥í•¨[m[m
[31m-[32m+[m[32m        token, _ = Token.objects.get_or_create(user=user)[m[m
[31m-[32m+[m[32m        # ì´ê±° ê°€ëŠ¥í•œ ì´ìœ ëŠ” userëŠ” Userì˜ ì¸ìŠ¤í„´ìŠ¤ê³  íŒŒì´ì¬ í´ë˜ìŠ¤ëŠ” getter setterì—†ì´ ê± ë­ë“  í•  ìˆ˜ ìˆì–´ì„œ[m[m
[31m-[32m+[m[32m        # ì´ë ‡ê²Œ í•˜ë©´ tokenì´ ì¶”ê°€ê°€ ê°€ëŠ¥í•œê±°ì„[m[m
[31m-[32m+[m[32m        # ì¶”ê°€ë¡œ ê± ê°ì²´ë¥¼ serializeì‹œí‚¤ë©´ ì•„ê¹Œë§í•œ __str__()ê°’ì´ ë“¤ì–´ê°[m[m
[31m-[32m+[m[32m        user.token = token[m[m
[31m-[32m+[m[32m        return user[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    def update(self, instance, validated_data):[m[m
[31m-[32m+[m[32m        # items()ì€ key, value íŠœí”ŒìŒì„ íŠœí”Œë¡œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ì„[m[m
[31m-[32m+[m[32m        print(instance.password)[m[m
[31m-[32m+[m[32m        for key, value in validated_data.items():[m[m
[31m-[32m+[m[32m            # ì œì¼ ì²«ë²ˆì§¸ ì¸ìì— keyê°€ ìˆìœ¼ë©´ True ì—†ìœ¼ë©´ False ë°˜í™˜í•˜ëŠ”ê²Œ hasattrì´ê³ [m[m
[31m-[32m+[m[32m            if hasattr(instance, key):[m[m
[31m-[32m+[m[32m                # ê°’ ì €ì¥í•˜ëŠ”ê²Œ setattr[m[m
[31m-[32m+[m[32m                setattr(instance, key, value)[m[m
[31m-[32m+[m[32m        instance.save()[m[m
[31m-[32m+[m[32m        return instance[m[m
[31m-[1mdiff --git a/industry_alert/account/views.py b/industry_alert/account/views.py[m[m
[31m-[1mindex 91ea44a..37c670b 100755[m[m
[31m-[1m--- a/industry_alert/account/views.py[m[m
[31m-[1m+++ b/industry_alert/account/views.py[m[m
[31m-[36m@@ -1,3 +1,121 @@[m[m
[31m-[31m-from django.shortcuts import render[m[m
[31m-[32m+[m[32mfrom rest_framework import viewsets, serializers, status[m[m
[31m-[32m+[m[32mfrom rest_framework.decorators import action[m[m
[31m-[32m+[m[32mfrom rest_framework.response import Response[m[m
[31m-[32m+[m[32mfrom rest_framework.permissions import AllowAny, IsAuthenticated[m[m
[31m-[32m+[m[32mfrom rest_framework.authtoken.models import Token[m[m
[31m-[32m+[m[32mfrom .models import User[m[m
[31m-[32m+[m[32mfrom .serializers import LoginSerializer, UserSerializer, InvalidPassword[m[m
[31m- [m[m
[31m-[31m-# Create your views here.[m[m
[31m-[32m+[m[32m# drf login[m[m
[31m-[32m+[m[32m# https://stackoverflow.com/questions/26906630/django-rest-framework-authentication-credentials-were-not-provided ì´ê±° ì§€ê¸ˆ í•´ê²°ì•ˆë˜ê³ ìˆìŒ[m[m
[31m-[32m+[m[32mclass AccountViewSet(viewsets.GenericViewSet):[m[m
[31m-[32m+[m[32m    # permission_classes = [AllowAny][m[m
[31m-[32m+[m[32m    queryset = User.objects.all()[m[m
[31m-[32m+[m[32m    serializer_class = UserSerializer[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # @actionì€[m[m
[31m-[32m+[m[32m    # This decorator can be used to add any custom endpoints that don't fit into the standard create/update/delete style.[m[m
[31m-[32m+[m[32m    # @action decorator will respond to GET requests by default.[m[m
[31m-[32m+[m[32m    # We can use the methods argument if we wanted an action that responded to POST requests.[m[m
[31m-[32m+[m[32m    # /.../foo/barë‚˜[m[m
[31m-[32m+[m[32m    # /.../foo/{pk}/bar[m[m
[31m-[32m+[m[32m    # ì´ëŸ° apië¥¼ ì¶”ê°€í•˜ê³ ì‹¶ì„ë•Œì“°ëŠ”ê±°ì„[m[m
[31m-[32m+[m[32m    # detail=Falseë©´ ìœ„ detail=Trueë©´ ì•„ë˜[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # @action(detail=True, methods=['get'])[m[m
[31m-[32m+[m[32m    # def asd(self, request, pk):[m[m
[31m-[32m+[m[32m    # ì´ê±°ë©´ http://localhost:8000/test/login/[pk]/asd ì—¬ê¸°ë¡œ ë“±ë¡ë¨[m[m
[31m-[32m+[m[32m    # detail=Falseì—¬ì•¼ì§€ë§Œ http://localhost:8000/test/login/asd/ë¡œ ê°[m[m
[31m-[32m+[m[32m    # http GET http://127.0.0.1:8000/api/v1/user/asd[m[m
[31m-[32m+[m[32m    @action(methods=['get'], detail=False, permission_classes=[AllowAny])[m[m
[31m-[32m+[m[32m    def asd(self, request):[m[m
[31m-[32m+[m[32m        serializer = self.serializer_class(self.queryset, many=True)[m[m
[31m-[32m+[m[32m        return Response(serializer.data)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # /api/v1/user ë¡œ GETìš”ì²­ ë°›ì„ user list api (UserSerializer ì‚¬ìš©)[m[m
[31m-[32m+[m[32m    # http GET http://127.0.0.1:8000/api/v1/user "Authorization: Token 01ecad58c74bb6a6c52ab3f8cb6946cb7312e0d6"[m[m
[31m-[32m+[m[32m    def list(self, request):[m[m
[31m-[32m+[m[32m        # self.get_queryset() ì´ê±°ë¡œ queryset = User.objects.all() ì´ê±° ê°€ì ¸ì˜¤ëŠ”ê±°ì„[m[m
[31m-[32m+[m[32m        queryset = self.get_queryset()[m[m
[31m-[32m+[m[32m        serializer = self.get_serializer(queryset, many=True)[m[m
[31m-[32m+[m[32m        return Response(serializer.data)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # /api/v1/user/pk ë¡œ GETìš”ì²­ ë°›ì„ user retrieve api (UserSerializerì‚¬ìš©)[m[m
[31m-[32m+[m[32m    # http GET http://127.0.0.1:8000/api/v1/user/48 "Authorization: Token 01ecad58c74bb6a6c52ab3f8cb6946cb7312e0d6"[m[m
[31m-[32m+[m[32m    def retrieve(self, request, pk):[m[m
[31m-[32m+[m[32m        # querysetê³¼ pkê°’ì„ ì¸ìë¡œ ë°›ì•„ì„œ,[m[m
[31m-[32m+[m[32m        # queryset.filter(pk=pk)ë¡œ querysetì„ ë½‘ê³ ,[m[m
[31m-[32m+[m[32m        # instance = queryset.get()ìœ¼ë¡œ ê°ì²´ë§Œ ë½‘ì•„ì„œ ë¦¬í„´í•´ ì£¼ëŠ” ë©”ì†Œë“œì„[m[m
[31m-[32m+[m[32m        # => ê²°êµ­, ìœ„ ì½”ë“œëŠ” Customer.objects.get(pk=pk) ë¦¬í„´í•¨[m[m
[31m-[32m+[m[32m        # https://velog.io/@jcinsh/RetrieveUpdateDestroyView-%EC%9D%B4%ED%95%B4 ì°¸ì¡°[m[m
[31m-[32m+[m[32m        # queryset = User.objects.all() ì´ê±°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ”ê±°ì„[m[m
[31m-[32m+[m[32m        instance = self.get_object()[m[m
[31m-[32m+[m[32m        serializer = self.get_serializer(instance)[m[m
[31m-[32m+[m[32m        return Response(serializer.data)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # /api/v1/user/pk ë¡œ PATCH ìš”ì²­ ë°›ì„ user update ap[m[m
[31m-[32m+[m[32m    # http PUT http://127.0.0.1:8000/api/v1/user/50 "Authorization: Token 01ecad58c74bb6a6c52ab3f8cb6946cb7312e0d6"[m[m
[31m-[32m+[m[32m    # ì´ê±° ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¾¸ë ¤ë©´ userserilaierì—ì„œ ë¹„ë°€ë²ˆí˜¸ê°€ readonlyì—¬ì„œ ì•ˆë³´ì´ë‹ˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¾¸ë ¤ë©´ serializerë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ì•¼í•¨[m[m
[31m-[32m+[m[32m    def update(self, request, pk):[m[m
[31m-[32m+[m[32m        instance = self.get_object()[m[m
[31m-[32m+[m[32m        # dataì•ì— ë­ê°€ ìˆìœ¼ë‹ˆ ì—…ë°ì´íŠ¸í•¨[m[m
[31m-[32m+[m[32m        serializer = self.get_serializer(instance, data=request.data, partial=True)[m[m
[31m-[32m+[m[32m        try:[m[m
[31m-[32m+[m[32m            serializer.is_valid(raise_exception=True)[m[m
[31m-[32m+[m[32m            serializer.save()[m[m
[31m-[32m+[m[32m            return Response(serializer.data)[m[m
[31m-[32m+[m[32m        except serializers.ValidationError:[m[m
[31m-[32m+[m[32m            return Response({"status": "failed", "errors": serializer.errors})[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # /api/v1/user/pk ë¡œ DELETE ìš”ì²­ ë°›ì„ user delete api (Serializer ì‚¬ìš© x)[m[m
[31m-[32m+[m[32m    # http DELETE http://127.0.0.1:8000/api/v1/user/2000 "Authorization: Token 01ecad58c74bb6a6c52ab3f8cb6946cb7312e0d6"[m[m
[31m-[32m+[m[32m    def delete(self, request, pk):[m[m
[31m-[32m+[m[32m        print("in delete")[m[m
[31m-[32m+[m[32m        instance = self.get_object()[m[m
[31m-[32m+[m[32m        instance.delete()[m[m
[31m-[32m+[m[32m        return Response({'success': True}, status=status.HTTP_204_NO_CONTENT)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # /api/v1/user ë¡œ POSTìš”ì²­ì„ ë°›ì„ registration api (UserSerializer ì‚¬ìš©)[m[m
[31m-[32m+[m[32m    # http POST http://127.0.0.1:8000/api/v1/user/register email="id@gmail.com" password="pw"[m[m
[31m-[32m+[m[32m    @action(detail=False, methods=['post'], permission_classes=[AllowAny])[m[m
[31m-[32m+[m[32m    def register(self, request):[m[m
[31m-[32m+[m[32m        serializer = self.get_serializer(data=request.data)[m[m
[31m-[32m+[m[32m        try:[m[m
[31m-[32m+[m[32m            serializer.is_valid(raise_exception=True)[m[m
[31m-[32m+[m[32m            # ì´ê±° save()í–ˆì„ë•Œ ë¶ˆë ¤ì˜¤ëŠ” methodëŠ”[m[m
[31m-[32m+[m[32m            # serializer = UserSerializer(data=request.data)ì—ì„œ dataì•ì— ë­ê°€ ì—†ìœ¼ë©´[m[m
[31m-[32m+[m[32m            # UserSerializer.create()ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ê±°ì„[m[m
[31m-[32m+[m[32m            serializer.save()[m[m
[31m-[32m+[m[32m            # ì´ê±° pwëŠ” write_onlyë¼ì„œ ì•ˆë³´ì„[m[m
[31m-[32m+[m[32m            print(serializer.data)[m[m
[31m-[32m+[m[32m            return Response(serializer.data)[m[m
[31m-[32m+[m[32m        except serializers.ValidationError:[m[m
[31m-[32m+[m[32m            return Response({"status": "failed", "errors": serializer.errors})[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # /api/v1/user/login ìœ¼ë¡œ POSTìš”ì²­ì„ ë°›ì„ login api (LoginSerializer ì‚¬ìš©)[m[m
[31m-[32m+[m[32m    # http POST http://127.0.0.1:8000/api/v1/user/login email="id@gmail.com" password="pw"[m[m
[31m-[32m+[m[32m    # ë¡œê·¸ì•„ì›ƒ ì•ˆí•˜ê³  ì„œë²„ê°€ ê·¸ëƒ¥ ë‹«ì•„ì§€ë©´ í† í° ê°’ì´ ìœ ì§€ë˜ëŠ”ê±° ê°™ìŒ ì–´ë–»ê²Œ í•´ê²°í•´ì•¼í•¨?[m[m
[31m-[32m+[m[32m    # ì´ê±° get_or_createë¡œ í•˜ê¸°ë•Œë¬¸ì— ê°™ì€ê±°ì„ ì•ˆê·¸ëŸ¬ë©´ ì„œë²„ê»ë‹¤ì¼°ëŠ”ë° ì• ë“¤ë‹¤ í† í° ë‚ ì•„ê°€ì„œ ë‹¤ ì—ëŸ¬ë‚˜ê±°ë‚˜ ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ë‚ ì•„ê°[m[m
[31m-[32m+[m[32m    # í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” í† í°ì— ë§Œë£Œê¸°í•œì„ ë‘ê³  í† í°ìœ ì¶œëŒ€ë„ credentialì´ ì—†ìœ¼ë©´ ë§Œë£Œì‹œì ì´í›„ì—ëŠ” ë¬´íš¨ì²˜ë¦¬ë˜ë„ë¡ ë‹¤ì‹œë¡œê·¸ì¸ì‹œì¼œë³´ëŠ”ê±°ì§€[m[m
[31m-[32m+[m[32m    @action(detail=False, methods=['post'], permission_classes=[AllowAny])[m[m
[31m-[32m+[m[32m    def login(self, request):[m[m
[31m-[32m+[m[32m        serializer = LoginSerializer(data=request.data)[m[m
[31m-[32m+[m[32m        try:[m[m
[31m-[32m+[m[32m            serializer.is_valid(raise_exception=True)[m[m
[31m-[32m+[m[32m            serializer.save()[m[m
[31m-[32m+[m[32m            return Response(serializer.data)[m[m
[31m-[32m+[m[32m        except InvalidPassword:[m[m
[31m-[32m+[m[32m            return Response({'success': False, 'error': 'íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'}, status=status.HTTP_400_BAD_REQUEST)[m[m
[31m-[32m+[m[32m        # ì´ê±°ëŠ” user = User.objects.get(email=email)ì—ì„œ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ raiseë¨[m[m
[31m-[32m+[m[32m        except User.DoesNotExist:[m[m
[31m-[32m+[m[32m            return Response({'success': False, 'error': 'ìœ ì €ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'}, status=status.HTTP_400_BAD_REQUEST)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # /api/v1/user/logout ìœ¼ë¡œ DELETE ìš”ì²­ì„ ë°›ì„ logout api(Serializer ì‚¬ìš© x)[m[m
[31m-[32m+[m[32m    # http POST http://127.0.0.1:8000/api/v1/user/logout "Authorization: Token f44c39fec18227d5aa555dcbd20aa7d56d0f55ef"[m[m
[31m-[32m+[m[32m    @action(detail=False, methods=['post'], permission_classes=[IsAuthenticated])[m[m
[31m-[32m+[m[32m    def logout(self, request):[m[m
[31m-[32m+[m[32m        request.user.auth_token.delete()[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m        return Response({'success': "ë¡œê·¸ì•„ì›ƒ ì„±ê³µ"}, status=status.HTTP_200_OK)[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m    # íŠ¹ì • ìœ ì €ê°€ publish í•œ post ë³´ê¸°[m[m
[31m-\ No newline at end of file[m[m
[31m-[1mdiff --git a/industry_alert/blog/models.py b/industry_alert/blog/models.py[m[m
[31m-[1mindex d486f8e..c380231 100644[m[m
[31m-[1m--- a/industry_alert/blog/models.py[m[m
[31m-[1m+++ b/industry_alert/blog/models.py[m[m
[31m-[36m@@ -2,16 +2,10 @@[m [mfrom django.conf import settings[m[m
[31m- from django.db import models[m[m
[31m- from django.utils import timezone[m[m
[31m- [m[m
[31m-[31m-# drf login[m[m
[31m-[31m-from django.contrib.auth.base_user import BaseUserManager, AbstractBaseUser[m[m
[31m-[31m-from django.contrib.auth.models import PermissionsMixin[m[m
[31m-[31m-[m[m
[31m- # image[m[m
[31m- from django.contrib.contenttypes.fields import GenericForeignKey[m[m
[31m- from django.contrib.contenttypes.models import ContentType[m[m
[31m- from django.contrib.contenttypes.fields import GenericRelation[m[m
[31m-[31m-# uuid[m[m
[31m-[31m-from uuid import uuid4[m[m
[31m- [m[m
[31m- class EntryImage(models.Model):[m[m
[31m-     def productFile(instance, filename):[m[m
[31m-[36m@@ -83,66 +77,4 @@[m [mclass Comment(models.Model):[m[m
[31m-         self.save()[m[m
[31m- [m[m
[31m-     def __str__(self):[m[m
[31m-[31m-        return self.text[m[m
[31m-[31m-[m[m
[31m-[31m-[m[m
[31m-[31m-# https://docs.djangoproject.com/en/3.2/ref/contrib/auth/[m[m
[31m-[31m-class AccountManager(BaseUserManager):[m[m
[31m-[31m-    def create_user(self, email, password, name):[m[m
[31m-[31m-        if not email:[m[m
[31m-[31m-            raise ValueError('Users must have an email address')[m[m
[31m-[31m-        print('ì–´ì¹´ìš´íŠ¸')[m[m
[31m-[31m-        # ì´ê±° ê·¼ë° ê¼­ í•´ì•¼í•˜ëŠ”ê±´ì§€ëŠ” ëª¨ë¥´ê² ìŒ[m[m
[31m-[31m-        user = self.model([m[m
[31m-[31m-            # normalize_email()ì´ê±°ëŠ” @domainì—ì„œ domainë§Œ ì†Œë¬¸ìë¡œ ë§Œë“¬[m[m
[31m-[31m-            email=self.normalize_email(email),[m[m
[31m-[31m-            name=name[m[m
[31m-[31m-        )[m[m
[31m-[31m-[m[m
[31m-[31m-        # Sets the userâ€™s password to the given raw string,[m[m
[31m-[31m-        # taking care of the password hashing. Doesnâ€™t save the User object.[m[m
[31m-[31m-        user.set_password(password)[m[m
[31m-[31m-        user.save()[m[m
[31m-[31m-        return user[m[m
[31m-[31m-[m[m
[31m-[31m-    def create_superuser(self, email, password, name):[m[m
[31m-[31m-        user = self.create_user([m[m
[31m-[31m-            email=self.normalize_email(email),[m[m
[31m-[31m-            password=password,[m[m
[31m-[31m-            name=name[m[m
[31m-[31m-        )[m[m
[31m-[31m-[m[m
[31m-[31m-        # https://docs.djangoproject.com/en/3.2/ref/contrib/auth/[m[m
[31m-[31m-        user.is_admin = True[m[m
[31m-[31m-        user.is_active=True[m[m
[31m-[31m-        user.is_superuser = True[m[m
[31m-[31m-        user.save()[m[m
[31m-[31m-[m[m
[31m-[31m-[m[m
[31m-[31m-# drf login[m[m
[31m-[31m-# https://medium.com/geekculture/register-login-and-logout-users-in-django-rest-framework-51486390c29[m[m
[31m-[31m-# https://github.com/django/django/blob/910ecd1b8df7678f45c3d507dde6bcb1faafa243/django/contrib/auth/base_user.py#L16 ì°¸ì¡°í•˜ê¸°[m[m
[31m-[31m-# ì—¬ê¸°ì— ì´ë¦„ ìƒë…„ì›”ì¼ ì „í™”ë²ˆí˜¸ ê°™ì€ ê±° ë” ì¶”ê°€í•˜ê¸°[m[m
[31m-[31m-class User(AbstractBaseUser, PermissionsMixin):[m[m
[31m-[31m-    email = models.EmailField(verbose_name="email", max_length=60, unique=True, default=None)[m[m
[31m-[31m-    password = models.CharField(verbose_name='password',max_length=255)[m[m
[31m-[31m-    # charfieldëŠ” null trueí•˜ëŠ”ê±°ì•„ë‹˜ ê°’ì´ ë¹„ì–´ìˆë‹¤ë¥¼ í‘œì‹œí•˜ëŠ”ê²Œ ë¹ˆìŠ¤íŠ¸ë§ì´ë‘ null ë‘ê°€ì§€ê°€ ë‹¤ë˜ë©´ì„œ ê³±ì°½ë‚¨[m[m
[31m-[31m-    name = models.CharField(verbose_name='name', max_length=30, default='', blank=True)[m[m
[31m-[31m-    is_admin = models.BooleanField(default=False)[m[m
[31m-[31m-    is_superuser = models.BooleanField(default=False)[m[m
[31m-[31m-[m[m
[31m-[31m-    # usernameìœ¼ë¡œ 'email' field ì‚¬ìš©í•¨[m[m
[31m-[31m-    USERNAME_FIELD = 'email'[m[m
[31m-[31m-[m[m
[31m-[31m-    # superuser ìƒì„±ì‹œ ì¶”ê°€ë¡œ ë°›ì„ê±°[m[m
[31m-[31m-    # https://docs.djangoproject.com/en/3.2/topics/auth/customizing/[m[m
[31m-[31m-    REQUIRED_FIELDS = ['name'][m[m
[31m-[31m-    [m[m
[31m-[31m-    objects = AccountManager()[m[m
[31m-[31m-[m[m
[31m-[31m-    @property[m[m
[31m-[31m-    def is_staff(self):[m[m
[31m-[31m-        return self.is_admin[m[m
[31m-[31m-[m[m
[31m-[31m-    def __str__(self):[m[m
[31m-[31m-        return str(self.email)[m[m
[31m-[32m+[m[32m        return self.text[m[m
[31m-\ No newline at end of file[m[m
[31m-[1mdiff --git a/industry_alert/blog/serializers.py b/industry_alert/blog/serializers.py[m[m
[31m-[1mindex e4fda24..6a54560 100644[m[m
[31m-[1m--- a/industry_alert/blog/serializers.py[m[m
[31m-[1m+++ b/industry_alert/blog/serializers.py[m[m
[31m-[36m@@ -1,9 +1,10 @@[m[m
[31m-[31m-from rest_framework import serializers[m[m
[31m-[31m-from .models import Post, Comment, User, EntryImage[m[m
[31m-[32m+[m[32mfrom django.contrib.auth import get_user_model[m[m
[31m-[32m+[m[32mfrom .models import Post, Comment, EntryImage[m[m
[31m- [m[m
[31m- # drf[m[m
[31m-[31m-from django.contrib.auth import get_user_model[m[m
[31m-[32m+[m[32mfrom rest_framework import serializers[m[m
[31m- from rest_framework.authtoken.models import Token[m[m
[31m-[32m+[m[32mfrom rest_framework.exceptions import ValidationError[m[m
[31m- # get_user_model() : í´ë˜ìŠ¤ì´ë‹¤.[m[m
[31m- # >>> get_user_model()[m[m
[31m- # <class 'accounts.models.User'>[m[m
[31m-[36m@@ -23,11 +24,6 @@[m [mclass ImageSerializer(serializers.ModelSerializer):[m[m
[31m-         # 'content_object' ì´ê±°ëŠ” dbì— ì‹¤ì œë¡œ ì¨ì§€ëŠ”ê²Œ ì•„ë‹ˆë¼ì„œ ì—†ì–´ë„ ë¨[m[m
[31m-         fields = ['id', 'image', 'content_type', 'object_id'][m[m
[31m- [m[m
[31m-[31m-# ì´ê±° ë”°ë¡œ .pyíŒŒì„œ ì˜®ê¸°ê¸°[m[m
[31m-[31m-class InvalidPassword(Exception):[m[m
[31m-[31m-    pass[m[m
[31m-[31m-[m[m
[31m-[31m-[m[m
[31m- class PostSerializer(serializers.ModelSerializer):[m[m
[31m-     # https://github.com/encode/django-rest-framework/blob/fdb49314754ff13d91c6eec7ccdb8ece52bea9eb/rest_framework/fields.py#L286[m[m
[31m-     author = serializers.HiddenField(default=serializers.CurrentUserDefault())[m[m
[31m-[36m@@ -101,96 +97,4 @@[m [mclass CommentSerializer(serializers.ModelSerializer):[m[m
[31m-     def validate_text(self, value):[m[m
[31m-         if 'ì‹œë²Œ' in value:[m[m
[31m-             raise ValidationError('ìš•í•˜ì§€ë§ˆë¼')[m[m
[31m-[31m-        return value[m[m
[31m-[31m-[m[m
[31m-[31m-[m[m
[31m-[31m-# drf[m[m
[31m-[31m-# 1. Serializerë¥¼ ìƒì†ë°›ì€ LoginSerializer, ê·¸ë¦¬ê³  ModelSerializerë¥¼ ìƒì†ë°›ì€ UserSerializer ë‘ ê°œ ì‘ì„±[m[m
[31m-[31m-# 2. ê° serializerëŠ” ì•„ë˜ì™€ ê°™ì€ fieldë¥¼ ê°€ì§€ê³  ì´ë¦„ì— ë§ëŠ” ë™ì‘ì„ í•´ì•¼í•¨[m[m
[31m-[31m-# https://eunjin3786.tistory.com/253[m[m
[31m-[31m-# LoginSerializer[m[m
[31m-[31m-#     ì“°ê¸°ì „ìš© : username, password[m[m
[31m-[31m-#     ì½ê¸°ì „ìš© : token[m[m
[31m-[31m-#     ë™ì‘ : usernameê³¼ passwordë¡œ userì¸ì¦ì„ í•˜ê³ , userì˜ tokenì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„, ì—†ìœ¼ë©´ ìƒˆë¡œ ë°œí–‰í•´ì„œ ëŒë ¤ì¤Œ[m[m
[31m-[31m-class LoginSerializer(serializers.Serializer):[m[m
[31m-[31m-    # write_onlyëŠ” ê°’ì„ ë°›ì•„ì„œ create/updateê°™ì€ê±°ë§Œ í•˜ëŠ”ê±°ì„[m[m
[31m-[31m-    email = serializers.CharField(write_only=True)[m[m
[31m-[31m-    password = serializers.CharField(write_only=True)[m[m
[31m-[31m-    # ì…ë ¥ë°›ëŠ”ê²Œ ì•„ë‹ˆë¼ returnìœ¼ë¡œ ëŒë ¤ì£¼ëŠ” ê°’ì´ë‹ˆê¹Œ read_onlyì„[m[m
[31m-[31m-    token = serializers.CharField(read_only=True)[m[m
[31m-[31m-[m[m
[31m-[31m-    # ë¡œê·¸ì¸ í™•ì¸[m[m
[31m-[31m-    def create(self, validated_data):[m[m
[31m-[31m-        email = validated_data['email'][m[m
[31m-[31m-        password = validated_data['password'][m[m
[31m-[31m-[m[m
[31m-[31m-        user = User.objects.get(email=email)[m[m
[31m-[31m-[m[m
[31m-[31m-        # ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜í•˜ë©´[m[m
[31m-[31m-        if user.check_password(password):[m[m
[31m-[31m-            token, _ = Token.objects.get_or_create(user=user)[m[m
[31m-[31m-            # ì´ê±° ê·¸ëƒ¥ return token í•˜ë©´ ì•ˆë¼ëŠ” ì´ìœ ëŠ”[m[m
[31m-[31m-            # ë°‘ì˜ ìœ ì €ì‹œë¦¬ì–¼ë¼ì´ì €ì—ì„œëŠ” user.tokenì— token.keyë¥¼ ë„£ì–´ì¤¬ëŠ”ë°[m[m
[31m-[31m-            # ì´ê±° ë¦¬í„´ë˜ëŠ” objectì—ì„œ getattrë¡œ ë¦¬í„´ fieldë“¤ì´ ë‹¤ ìˆìœ¼ë©´ ì•Œì•„ì„œ ë§Œë“¤ì–´ì£¼ëŠ”ê±´ë°[m[m
[31m-[31m-            # ë°‘ì—ì„œëŠ” ë¦¬í„´ì´ userê°ì²´ì˜€ê³  ì´ ê°ì²´ì—ëŠ” class Metaì— ìˆëŠ” 3ê°œì˜ fieldê°€ ë‹¤ ìˆì–´ì„œ ë¬¸ì œì—†ì´ ëœê±°ê³ [m[m
[31m-[31m-            # ì§€ê¸ˆì€ tokenì„ ë¦¬í„´í•˜ê²Œ ë˜ë©´ token.tokenì€ ì—†ê³  token.keyì— ì›í•˜ëŠ”ê°’ì´ìˆì§€[m[m
[31m-[31m-            # ê·¸ë˜ì„œ ì§€ê¸ˆ ì—ëŸ¬ì¸ {}ê°€ ê°€ëŠ”ê±°ì„[m[m
[31m-[31m-            # tokenì„ ë¦¬í„´í•˜ë©´ Token objectì¸ë° ë‚´ê°€ serializerì— ë¦¬í„´í•˜ê² ë‹¤ê³  ëª…ì‹œí•œê±´[m[m
[31m-[31m-            # tokenì´ë¼ëŠ” í•„ë“œê³  ë¦¬í„´í•œê±¸ serializeí–ˆì„ë•Œ ë¦¬í„´ ê²°ê³¼ë¬¼ì— tokenì´ë¼ëŠ” attributeê°€ ìˆì–´ì•¼í•˜ëŠ”ë°[m[m
[31m-[31m-            # token.tokenì´ ì—†ìœ¼ë‹ˆ ì•„ë¬´ëŸ° ê²°ê³¼ë¬¼ì´ ì•ˆë‚˜ì˜¤ëŠ”ê±°ì„[m[m
[31m-[31m-            # ì´ì œ {'token': token.key}ë¥¼ ë¦¬í„´í•˜ë©´ getattr(ë¦¬í„´ ê²°ê³¼ë¬¼, 'token')í•˜ë©´[m[m
[31m-[31m-            # ê°’ì´ ìˆìœ¼ë‹ˆ ê²°ê³¼ë¬¼ì´ ë‚˜ì˜¤ëŠ”ê±°ì„[m[m
[31m-[31m-            # ê°ì²´ serializeí•˜ë©´ __str__()ë¡œ ë‚˜ì˜¤ëŠ” ê²°ê³¼ë¬¼ì´ ë‚˜ì˜´[m[m
[31m-[31m-            # print(getattr(token, 'key'))[m[m
[31m-[31m-            print(token.key)[m[m
[31m-[31m-            return {'token': token.key}[m[m
[31m-[31m-        # ì¼ì¹˜í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´[m[m
[31m-[31m-        raise InvalidPassword[m[m
[31m-[31m-[m[m
[31m-[31m-[m[m
[31m-[31m-# UserSerializer[m[m
[31m-[31m-#     ë‘˜ ë‹¤ : í•„ìš”í•œ ëª¨ë“  ìœ ì €ì •ë³´ë“¤[m[m
[31m-[31m-#     ì“°ê¸°ì „ìš© : password[m[m
[31m-[31m-#     ì½ê¸°ì „ìš© : token[m[m
[31m-[31m-#     ë™ì‘ : ë°›ì€ userì •ë³´ë¥¼ í†µí•´ Userë¥¼ ìƒì„±í•˜ê³ , ìƒì„±ëœ userì˜ tokenì„ ìƒˆë¡œ ë°œí–‰í•´ì„œ passwordë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì •ë³´ì™€ í•¨ê»˜ ëŒë ¤ì¤Œ[m[m
[31m-[31m-class UserSerializer(serializers.ModelSerializer):[m[m
[31m-[31m-    password = serializers.CharField(write_only=True)[m[m
[31m-[31m-    token = serializers.CharField(read_only=True)[m[m
[31m-[31m-[m[m
[31m-[31m-    class Meta:[m[m
[31m-[31m-        model = get_user_model()[m[m
[31m-[31m-        fields = ['email', 'password', 'name', 'token'][m[m
[31m-[31m-[m[m
[31m-[31m-    # ì´ê±° ê·¼ë° user.mode()ì—ì„œ í•´ì£¼ëŠ”ë° ì—†ì–´ì•¼í•˜ëŠ”ê±° ê°™ìŒ[m[m
[31m-[31m-    # overrideí•˜ëŠ”ê±°ë‹ˆê¹Œ ì¸ì ë§ì¶°ì¤˜ì•¼í•¨[m[m
[31m-[31m-    def create(self, validated_data):[m[m
[31m-[31m-        print("ìœ ì €ì‹œë¦¬ì–¼ë¼ì´ì € - create")[m[m
[31m-[31m-        # ì´ì œ ì´ validate_dataëŠ” validationë„ ëë‚¬ìœ¼ë‹ˆ ì •í•©í•œ ë°ì´í„°ë‹ˆ ê·¸ëƒ¥ ë•Œë ¤ë²„ë¦¬ë©´ ë¨[m[m
[31m-[31m-        # ì´ê±° **ì€[m[m
[31m-[31m-        # **d means "take all additional named arguments to this function[m[m
[31m-[31m-        # and insert them into this parameter as dictionary entries."[m[m
[31m-[31m-        # ì´ê±° create_userê°€ ì¸ìë¥¼ 2ê°œ ë°›ì•„ì•¼í•˜ë‹ˆ **validated_data[m[m
[31m-[31m-        user = User.objects.create_user(**validated_data)[m[m
[31m-[31m-        # ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒì„±í•œê°’ì´ë‘[m[m
[31m-[31m-        # ìƒì„±ëëŠ”ì§€ ê°€ì ¸ì˜¨ê±´ì§€ ì—¬ë¶€ë¥¼[m[m
[31m-[31m-        # íŠœí”Œë¡œì¤Œ[m[m
[31m-[31m-        # ì €ê²Œ ìƒì„±ìœ¼ë¡œ ê°€ì ¸ì˜¨ ê²°ê³¼ë¬¼ì´ë©´ True[m[m
[31m-[31m-        # ìˆë˜ê±° ê°€ì ¸ì˜¨ê±°ë©´ False[m[m
[31m-[31m-        # _ëŠ” ì•ˆì“¸ê°’ì€ _ë¡œ ì €ì¥í•¨[m[m
[31m-[31m-        token, _ = Token.objects.get_or_create(user=user)[m[m
[31m-[31m-        # ì´ê±° ê°€ëŠ¥í•œ ì´ìœ ëŠ” userëŠ” Userì˜ ì¸ìŠ¤í„´ìŠ¤ê³  íŒŒì´ì¬ í´ë˜ìŠ¤ëŠ” getter setterì—†ì´ ê± ë­ë“  í•  ìˆ˜ ìˆì–´ì„œ[m[m
[31m-[31m-        # ì´ë ‡ê²Œ í•˜ë©´ tokenì´ ì¶”ê°€ê°€ ê°€ëŠ¥í•œê±°ì„[m[m
[31m-[31m-        # ì¶”ê°€ë¡œ ê± ê°ì²´ë¥¼ serializeì‹œí‚¤ë©´ ì•„ê¹Œë§í•œ __str__()ê°’ì´ ë“¤ì–´ê°[m[m
[31m-[31m-        user.token = token[m[m
[31m-[31m-        return user[m[m
[31m-[31m-[m[m
[31m-[31m-    def update(self, instance, validated_data):[m[m
[31m-[31m-        # items()ì€ key, value íŠœí”ŒìŒì„ íŠœí”Œë¡œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ì„[m[m
[31m-[31m-        print(instance.password)[m[m
[31m-[31m-        for key, value in validated_data.items():[m[m
[31m-[31m-            # ì œì¼ ì²«ë²ˆì§¸ ì¸ìì— keyê°€ ìˆìœ¼ë©´ True ì—†ìœ¼ë©´ False ë°˜í™˜í•˜ëŠ”ê²Œ hasattrì´ê³ [m[m
[31m-[31m-            if hasattr(instance, key):[m[m
[31m-[31m-                # ê°’ ì €ì¥í•˜ëŠ”ê²Œ setattr[m[m
[31m-[31m-                setattr(instance, key, value)[m[m
[31m-[31m-        instance.save()[m[m
[31m-[31m-        return instance[m[m
[31m-[32m+[m[32m        return value[m[m
[31m-\ No newline at end of file[m[m
[31m-[1mdiff --git a/industry_alert/blog/views.py b/industry_alert/blog/views.py[m[m
[31m-[1mindex f27e65c..5397489 100644[m[m
[31m-[1m--- a/industry_alert/blog/views.py[m[m
[31m-[1m+++ b/industry_alert/blog/views.py[m[m
[31m-[36m@@ -3,6 +3,7 @@[m [mfrom django.utils import timezone # timezone.now() ì‚¬ìš©í•˜ê¸° ìœ„í•¨ì„[m[m
[31m- from rest_framework.exceptions import ParseError[m[m
[31m- [m[m
[31m- from .models import Post, Comment # Postëª¨ë¸, Commentëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•¨ì„[m[m
[31m-[32m+[m[32mfrom .serializers import PostSerializer, CommentSerializer[m[m
[31m- from .forms import PostForm, CommentForm[m[m
[31m- from django.shortcuts import redirect[m[m
[31m- from django.contrib.auth.decorators import login_required[m[m
[31m-[36m@@ -11,8 +12,6 @@[m [mfrom django.contrib.auth.decorators import login_required[m[m
[31m- from rest_framework import viewsets[m[m
[31m- from rest_framework.decorators import action[m[m
[31m- from rest_framework.response import Response[m[m
[31m-[31m-from blog.models import Post, Comment, User[m[m
[31m-[31m-from blog.serializers import PostSerializer, CommentSerializer, LoginSerializer, UserSerializer, InvalidPassword[m[m
[31m- from rest_framework.permissions import AllowAny, IsAuthenticated[m[m
[31m- from rest_framework import serializers[m[m
[31m- from rest_framework import status[m[m
[31m-[36m@@ -112,55 +111,31 @@[m [mclass EveLoginViewSet(viewsets.GenericViewSet):[m[m
[31m-                 headers=headers,[m[m
[31m-                 data=body[m[m
[31m-             )[m[m
[31m-[31m-            res.raise_for_status()[m[m
[31m-             res_dict = res.json()[m[m
[31m-[31m-        except requests.exceptions.ConnectionError as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        except requests.exceptions.Timeout as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        except requests.exceptions.TooManyRedirects as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        # raise_for_status()[m[m
[31m-[31m-        except requests.exceptions.HTTPError as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        # res.json()[m[m
[31m-[31m-        except requests.exceptions.JSONDecodeError as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        # ìœ„ì—ì„œ ê±¸ë¦¬ì§€ ì•Šì€ ë‹¤ë¥¸ ëª¨ë“  exceptions[m[m
[31m-[31m-        except requests.exceptions.RequestException as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        [m[m
[31m-[31m-        if 'error' in res_dict:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": "something went wrong"})[m[m
[31m-[32m+[m[32m            access_token = res_dict.get('access_token')[m[m
[31m-[32m+[m[32m            # ì´ê±° ì–´ì°¨í”¼ ì—¬ê¸°ì„œ access_tokenì´ ì•ˆì˜¨ê±°ë©´ ì—°ê²°ì´  ì‹¤íŒ¨í•œê±°ì„[m[m
[31m-[32m+[m[32m            # ê·¸ëŸ¬ë‹ˆê¹Œ ì˜ˆì™¸ëŠ” ì—¬ê¸°ì„œ keyErrorí•˜ë‚˜ë§Œ ì¡ê³  ë‚˜ë¨¸ì§€ ë‹¤ë¥¸ ì—ëŸ¬ëŠ”[m[m
[31m-[32m+[m[32m            # djangoì—ì„œ 500ì—ëŸ¬ ì£¼ë‹ˆ ì´ê±° logging í•´ì„œ ì¡ì•„ë‚´ë©´ë¨[m[m
[31m-[32m+[m[32m            # í´ë¼ì´ì–¸íŠ¸ëŠ” ì¡ë‹¤í•œ ì˜ˆì™¸ ìƒí™© ì•Œ í•„ìš”ì—†ê³  ì—¬ê¸° ê¸°ì¤€ìœ¼ë¡œëŠ” ì´ë¸Œì™€ì˜ ì„œë²„ í†µì‹ ì„ ì‹¤íŒ¨í•œê±°ë§Œ ì•Œë©´ ë˜ê¸° ë–„ë¬¸ì—[m[m
[31m-[32m+[m[32m            # ê·¸ëƒ¥ access_token ì—†ìœ¼ë©´ ì´ë¸Œ ì„œë²„ì™€ì˜ í†µì‹ ì´ ì‹¤íŒ¨í•œê±°ë‹ˆ ì‹¤íŒ¨í–ˆë‹¤ê³  ì•Œë ¤ì£¼ë©´ë¨.[m[m
[31m-[32m+[m[32m        except KeyError:[m[m
[31m-[32m+[m[32m            return Response({"status": "failed", "errors": "ì´ë¸Œì„œë²„ì™€ í†µì‹ ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."})[m[m
[31m-[32m+[m[m
[31m-         # If the previous step was done correctly, the EVE SSO will respond with a JSON payload containing an access token (which is a Json Web Token) [m[m
[31m-         # and a refresh token that looks like this (Anything wrapped by <> will look different for you):[m[m
[31m-[31m-        # ì´ê²Œ resì— ì €ì¥ë¨[m[m
[31m-[31m-        acc = 'Bearer ' + res_dict['access_token'][m[m
[31m-[32m+[m[32m        # ì—¬ê¸°ì„œ ë§í•˜ëŠ” JSON payloadê°€ ìœ„ì˜ resì— ì €ì¥ë¨[m[m
[31m-[32m+[m[32m        acc = 'Bearer ' + access_token[m[m
[31m-         try:[m[m
[31m-             character_res = requests.get([m[m
[31m-                 "https://login.eveonline.com/oauth/verify",[m[m
[31m-[31m-                headers= {'Authorization': acc}[m[m
[31m-[32m+[m[32m                headers={"Authorization": acc}[m[m
[31m-             )[m[m
[31m-[31m-            character_res.raise_for_status()[m[m
[31m-             character_dict = character_res.json()[m[m
[31m-[31m-        except requests.exceptions.ConnectionError as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        except requests.exceptions.Timeout as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        except requests.exceptions.TooManyRedirects as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        # raise_for_status()[m[m
[31m-[31m-        except requests.exceptions.HTTPError as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        # res.json()[m[m
[31m-[31m-        except requests.exceptions.JSONDecodeError as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-        # ìœ„ì—ì„œ ê±¸ë¦¬ì§€ ì•Šì€ ë‹¤ë¥¸ ëª¨ë“  exceptions[m[m
[31m-[31m-        except requests.exceptions.RequestException as e:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": str(e)})[m[m
[31m-[31m-[m[m
[31m-[31m-        # urll = 'https://esi.evetech.net/latest/characters/' + str(character_id)+ '/industry/jobs/?datasource=tranquility'[m[m
[31m-[31m-        esi_request_url = self.url_creater(character_dict['CharacterID'], 'industry_jobs')[m[m
[31m-[32m+[m[32m            character_id = character_dict['CharacterID'][m[m
[31m-[32m+[m[32m        except KeyError:[m[m
[31m-[32m+[m[32m            return Response({"status": "failed", "errors": "ì´ë¸Œì„œë²„ì™€ í†µì‹ ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."})[m[m
[31m-[32m+[m[m
[31m-[32m+[m[32m        esi_request_url = self.url_creater(character_id, 'industry_jobs')[m[m
[31m-         [m[m
[31m-         res4 = requests.get([m[m
[31m-              esi_request_url,[m[m
[31m-[36m@@ -404,120 +379,6 @@[m [mclass CommentViewSet(viewsets.GenericViewSet):[m[m
[31m-         except serializers.ValidationError:[m[m
[31m-             return Response({"status": "failed", "errors": serializer.errors})[m[m
[31m- [m[m
[31m-[31m-# drf login[m[m
[31m-[31m-# https://stackoverflow.com/questions/26906630/django-rest-framework-authentication-credentials-were-not-provided ì´ê±° ì§€ê¸ˆ í•´ê²°ì•ˆë˜ê³ ìˆìŒ[m[m
[31m-[31m-class AccountViewSet(viewsets.GenericViewSet):[m[m
[31m-[31m-    # permission_classes = [AllowAny][m[m
[31m-[31m-    queryset = User.objects.all()[m[m
[31m-[31m-    serializer_class = UserSerializer[m[m
[31m-[31m-[m[m
[31m-[31m-    # @actionì€ [m[m
[31m-[31m-    # This decorator can be used to add any custom endpoints that don't fit into the standard create/update/delete style.[m[m
[31m-[31m-    # @action decorator will respond to GET requests by default. [m[m
[31m-[31m-    # We can use the methods argument if we wanted an action that responded to POST requests.[m[m
[31m-[31m-    # /.../foo/barë‚˜[m[m
[31m-[31m-    # /.../foo/{pk}/bar[m[m
[31m-[31m-    # ì´ëŸ° apië¥¼ ì¶”ê°€í•˜ê³ ì‹¶ì„ë•Œì“°ëŠ”ê±°ì„[m[m
[31m-[31m-    # detail=Falseë©´ ìœ„ detail=Trueë©´ ì•„ë˜[m[m
[31m-[31m-[m[m
[31m-[31m-    # @action(detail=True, methods=['get'])[m[m
[31m-[31m-    # def asd(self, request, pk):[m[m
[31m-[31m-    # ì´ê±°ë©´ http://localhost:8000/test/login/[pk]/asd ì—¬ê¸°ë¡œ ë“±ë¡ë¨[m[m
[31m-[31m-    # detail=Falseì—¬ì•¼ì§€ë§Œ http://localhost:8000/test/login/asd/ë¡œ ê°[m[m
[31m-[31m-    # http GET http://127.0.0.1:8000/api/v1/user/asd[m[m
[31m-[31m-    @action(methods=['get'], detail=False, permission_classes=[AllowAny])[m[m
[31m-[31m-    def asd(self, request):[m[m
[31m-[31m-        serializer = self.serializer_class(self.queryset, many=True)[m[m
[31m-[31m-        return Response(serializer.data)[m[m
[31m-[31m-[m[m
[31m-[31m-    # /api/v1/user ë¡œ GETìš”ì²­ ë°›ì„ user list api (UserSerializer ì‚¬ìš©)[m[m
[31m-[31m-    # http GET http://127.0.0.1:8000/api/v1/user "Authorization: Token 01ecad58c74bb6a6c52ab3f8cb6946cb7312e0d6"[m[m
[31m-[31m-    def list(self, request):[m[m
[31m-[31m-        # self.get_queryset() ì´ê±°ë¡œ queryset = User.objects.all() ì´ê±° ê°€ì ¸ì˜¤ëŠ”ê±°ì„[m[m
[31m-[31m-        queryset = self.get_queryset()[m[m
[31m-[31m-        serializer = self.get_serializer(queryset, many=True)[m[m
[31m-[31m-        return Response(serializer.data)[m[m
[31m-[31m-[m[m
[31m-[31m-    # /api/v1/user/pk ë¡œ GETìš”ì²­ ë°›ì„ user retrieve api (UserSerializerì‚¬ìš©)[m[m
[31m-[31m-    # http GET http://127.0.0.1:8000/api/v1/user/48 "Authorization: Token 01ecad58c74bb6a6c52ab3f8cb6946cb7312e0d6"[m[m
[31m-[31m-    def retrieve(self, request, pk):[m[m
[31m-[31m-        # querysetê³¼ pkê°’ì„ ì¸ìë¡œ ë°›ì•„ì„œ,[m[m
[31m-[31m-        # queryset.filter(pk=pk)ë¡œ querysetì„ ë½‘ê³ ,[m[m
[31m-[31m-        # instance = queryset.get()ìœ¼ë¡œ ê°ì²´ë§Œ ë½‘ì•„ì„œ ë¦¬í„´í•´ ì£¼ëŠ” ë©”ì†Œë“œì„[m[m
[31m-[31m-        # => ê²°êµ­, ìœ„ ì½”ë“œëŠ” Customer.objects.get(pk=pk) ë¦¬í„´í•¨[m[m
[31m-[31m-        # https://velog.io/@jcinsh/RetrieveUpdateDestroyView-%EC%9D%B4%ED%95%B4 ì°¸ì¡°[m[m
[31m-[31m-        # queryset = User.objects.all() ì´ê±°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ”ê±°ì„[m[m
[31m-[31m-        instance = self.get_object()[m[m
[31m-[31m-        serializer = self.get_serializer(instance)[m[m
[31m-[31m-        return Response(serializer.data)[m[m
[31m-[31m-[m[m
[31m-[31m-    # /api/v1/user/pk ë¡œ PATCH ìš”ì²­ ë°›ì„ user update ap[m[m
[31m-[31m-    # http PUT http://127.0.0.1:8000/api/v1/user/50 "Authorization: Token 01ecad58c74bb6a6c52ab3f8cb6946cb7312e0d6"[m[m
[31m-[31m-    # ì´ê±° ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¾¸ë ¤ë©´ userserilaierì—ì„œ ë¹„ë°€ë²ˆí˜¸ê°€ readonlyì—¬ì„œ ì•ˆë³´ì´ë‹ˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¾¸ë ¤ë©´ serializerë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ì•¼í•¨[m[m
[31m-[31m-    def update(self, request, pk):[m[m
[31m-[31m-        instance = self.get_object()[m[m
[31m-[31m-        # dataì•ì— ë­ê°€ ìˆìœ¼ë‹ˆ ì—…ë°ì´íŠ¸í•¨[m[m
[31m-[31m-        serializer = self.get_serializer(instance, data=request.data, partial=True)[m[m
[31m-[31m-        try:[m[m
[31m-[31m-            serializer.is_valid(raise_exception=True)[m[m
[31m-[31m-            serializer.save()[m[m
[31m-[31m-            return Response(serializer.data)[m[m
[31m-[31m-        except serializers.ValidationError:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": serializer.errors})[m[m
[31m-[31m-[m[m
[31m-[31m-    # /api/v1/user/pk ë¡œ DELETE ìš”ì²­ ë°›ì„ user delete api (Serializer ì‚¬ìš© x)[m[m
[31m-[31m-    # http DELETE http://127.0.0.1:8000/api/v1/user/2000 "Authorization: Token 01ecad58c74bb6a6c52ab3f8cb6946cb7312e0d6"[m[m
[31m-[31m-    def delete(self, request, pk):[m[m
[31m-[31m-        print("in delete")[m[m
[31m-[31m-        instance = self.get_object()[m[m
[31m-[31m-        instance.delete()[m[m
[31m-[31m-        return Response({'success': True}, status=status.HTTP_204_NO_CONTENT)[m[m
[31m-[31m-[m[m
[31m-[31m-    # /api/v1/user ë¡œ POSTìš”ì²­ì„ ë°›ì„ registration api (UserSerializer ì‚¬ìš©)[m[m
[31m-[31m-    # http POST http://127.0.0.1:8000/api/v1/user/register email="id@gmail.com" password="pw"[m[m
[31m-[31m-    @action(detail=False, methods=['post'], permission_classes=[AllowAny])[m[m
[31m-[31m-    def register(self, request):[m[m
[31m-[31m-        serializer = self.get_serializer(data=request.data)[m[m
[31m-[31m-        try:[m[m
[31m-[31m-            serializer.is_valid(raise_exception=True)[m[m
[31m-[31m-            # ì´ê±° save()í–ˆì„ë•Œ ë¶ˆë ¤ì˜¤ëŠ” methodëŠ”[m[m
[31m-[31m-            # serializer = UserSerializer(data=request.data)ì—ì„œ dataì•ì— ë­ê°€ ì—†ìœ¼ë©´[m[m
[31m-[31m-            # UserSerializer.create()ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ê±°ì„[m[m
[31m-[31m-            serializer.save()[m[m
[31m-[31m-            # ì´ê±° pwëŠ” write_onlyë¼ì„œ ì•ˆë³´ì„[m[m
[31m-[31m-            print(serializer.data)[m[m
[31m-[31m-            return Response(serializer.data)[m[m
[31m-[31m-        except serializers.ValidationError:[m[m
[31m-[31m-            return Response({"status": "failed", "errors": serializer.errors})[m[m
[31m-[31m-[m[m
[31m-[31m-    # /api/v1/user/login ìœ¼ë¡œ POSTìš”ì²­ì„ ë°›ì„ login api (LoginSerializer ì‚¬ìš©)[m[m
[31m-[31m-    # http POST http://127.0.0.1:8000/api/v1/user/login email="id@gmail.com" password="pw"[m[m
[31m-[31m-    # ë¡œê·¸ì•„ì›ƒ ì•ˆí•˜ê³  ì„œë²„ê°€ ê·¸ëƒ¥ ë‹«ì•„ì§€ë©´ í† í° ê°’ì´ ìœ ì§€ë˜ëŠ”ê±° ê°™ìŒ ì–´ë–»ê²Œ í•´ê²°í•´ì•¼í•¨?[m[m
[31m-[31m-    # ì´ê±° get_or_createë¡œ í•˜ê¸°ë•Œë¬¸ì— ê°™ì€ê±°ì„ ì•ˆê·¸ëŸ¬ë©´ ì„œë²„ê»ë‹¤ì¼°ëŠ”ë° ì• ë“¤ë‹¤ í† í° ë‚ ì•„ê°€ì„œ ë‹¤ ì—ëŸ¬ë‚˜ê±°ë‚˜ ë¡œê·¸ì¸í˜ì´ì§€ë¡œ ë‚ ì•„ê°[m[m
[31m-[31m-    # í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” í† í°ì— ë§Œë£Œê¸°í•œì„ ë‘ê³  í† í°ìœ ì¶œëŒ€ë„ credentialì´ ì—†ìœ¼ë©´ ë§Œë£Œì‹œì ì´í›„ì—ëŠ” ë¬´íš¨ì²˜ë¦¬ë˜ë„ë¡ ë‹¤ì‹œë¡œê·¸ì¸ì‹œì¼œë³´ëŠ”ê±°ì§€[m[m
[31m-[31m-    @action(detail=False, methods=['post'], permission_classes=[AllowAny])[m[m
[31m-[31m-    def login(self, request):[m[m
[31m-[31m-        serializer = LoginSerializer(data=request.data)[m[m
[31m-[31m-        try:[m[m
[31m-[31m-            serializer.is_valid(raise_exception=True)[m[m
[31m-[31m-            serializer.save()[m[m
[31m-[31m-            return Response(serializer.data)[m[m
[31m-[31m-        except InvalidPassword:[m[m
[31m-[31m-            return Response({'success': False, 'error': 'íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'}, status=status.HTTP_400_BAD_REQUEST)[m[m
[31m-[31m-        # ì´ê±°ëŠ” user = User.objects.get(email=email)ì—ì„œ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ raiseë¨[m[m
[31m-[31m-        except User.DoesNotExist:[m[m
[31m-[31m-            return Response({'success': False, 'error': 'ìœ ì €ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'}, status=status.HTTP_400_BAD_REQUEST)[m[m
[31m-[31m-[m[m
[31m-[31m-    # /api/v1/user/logout ìœ¼ë¡œ DELETE ìš”ì²­ì„ ë°›ì„ logout api(Serializer ì‚¬ìš© x)[m[m
[31m-[31m-    # http POST http://127.0.0.1:8000/api/v1/user/logout "Authorization: Token f44c39fec18227d5aa555dcbd20aa7d56d0f55ef"[m[m
[31m-[31m-    @action(detail=False, methods=['post'], permission_classes=[IsAuthenticated])[m[m
[31m-[31m-    def logout(self, request):[m[m
[31m-[31m-        request.user.auth_token.delete()[m[m
[31m-[31m-[m[m
[31m-[31m-        return Response({'success': "ë¡œê·¸ì•„ì›ƒ ì„±ê³µ"}, status=status.HTTP_200_OK)[m[m
[31m-[31m-    [m[m
[31m-[31m-    # íŠ¹ì • ìœ ì €ê°€ publish í•œ post ë³´ê¸°[m[m
[31m-[31m-[m[m
[31m- def post_list(request):[m[m
[31m-     # ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ì„œ htmlë¡œ ë³´ëƒ„[m[m
[31m-     posts = Post.objects.filter(published_date__lte=timezone.now()).order_by('published_date')[m[m
[31m-[1mdiff --git a/industry_alert/db.sqlite3 b/industry_alert/db.sqlite3[m[m
[31m-[1mdeleted file mode 100644[m[m
[31m-[1mindex 501f3c2..0000000[m[m
[31m-Binary files a/industry_alert/db.sqlite3 and /dev/null differ[m
[31m-[1mdiff --git a/industry_alert/mysite/settings.py b/industry_alert/mysite/settings.py[m[m
[31m-[1mindex ff4f7da..b40da6c 100644[m[m
[31m-[1m--- a/industry_alert/mysite/settings.py[m[m
[31m-[1m+++ b/industry_alert/mysite/settings.py[m[m
[31m-[36m@@ -55,6 +55,7 @@[m [mINSTALLED_APPS = [[m[m
[31m-     'django.contrib.messages',[m[m
[31m-     'django.contrib.staticfiles',[m[m
[31m-     'blog', # blog ì‚¬ìš©í•œë‹¤ê³  ì•Œë ¤ì¤˜ì•¼í•¨[m[m
[31m-[32m+[m[32m    'account',[m[m
[31m-     # drf login[m[m
[31m-     "rest_framework",[m[m
[31m-     "rest_framework.authtoken",[m[m
[31m-[1mdiff --git a/industry_alert/sqlite3.exe b/industry_alert/sqlite3.exe[m[m
[31m-[1mdeleted file mode 100644[m[m
[31m-[1mindex 4ad1ad4..0000000[m[m
[31m-Binary files a/industry_alert/sqlite3.exe and /dev/null differ[m
[1mdiff --git a/industry_alert/account/admin.py b/industry_alert/account/admin.py[m
[1mindex 8c38f3f..63417c4 100755[m
[1m--- a/industry_alert/account/admin.py[m
[1m+++ b/industry_alert/account/admin.py[m
[36m@@ -1,3 +1,5 @@[m
 from django.contrib import admin[m
[32m+[m[32mfrom .models import EveAccessToken[m
 [m
[31m-# Register your models here.[m
[32m+[m[32m# ModelAdmin classë¥¼ defineí•˜ì§€ ì•Šìœ¼ë©´ default admin interfaceê°€ ì œê³µë¨[m
[32m+[m[32madmin.site.register(EveAccessToken)[m
[1mdiff --git a/industry_alert/account/migrations/0001_initial.py b/industry_alert/account/migrations/0001_initial.py[m
[1mindex 9896968..13ef5b7 100644[m
[1m--- a/industry_alert/account/migrations/0001_initial.py[m
[1m+++ b/industry_alert/account/migrations/0001_initial.py[m
[36m@@ -1,6 +1,9 @@[m
[31m-# Generated by Django 3.2.5 on 2021-11-06 10:28[m
[32m+[m[32m# Generated by Django 3.2.5 on 2021-11-23 09:11[m
 [m
[32m+[m[32mfrom django.conf import settings[m
 from django.db import migrations, models[m
[32m+[m[32mimport django.db.models.deletion[m
[32m+[m[32mimport django.utils.timezone[m
 [m
 [m
 class Migration(migrations.Migration):[m
[36m@@ -20,6 +23,7 @@[m [mclass Migration(migrations.Migration):[m
                 ('email', models.EmailField(default=None, max_length=60, unique=True, verbose_name='email')),[m
                 ('password', models.CharField(max_length=255, verbose_name='password')),[m
                 ('name', models.CharField(blank=True, default='', max_length=30, verbose_name='name')),[m
[32m+[m[32m                ('character_id', models.IntegerField(blank=True, default=0, verbose_name='character_id')),[m
                 ('is_admin', models.BooleanField(default=False)),[m
                 ('is_superuser', models.BooleanField(default=False)),[m
                 ('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.Group', verbose_name='groups')),[m
[36m@@ -29,4 +33,15 @@[m [mclass Migration(migrations.Migration):[m
                 'abstract': False,[m
             },[m
         ),[m
[32m+[m[32m        migrations.CreateModel([m
[32m+[m[32m            name='EveAccessToken',[m
[32m+[m[32m            fields=[[m
[32m+[m[32m                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),[m
[32m+[m[32m                ('access_token', models.TextField()),[m
[32m+[m[32m                ('expires_in', models.DateTimeField(default=django.utils.timezone.now)),[m
[32m+[m[32m                ('token_type', models.CharField(max_length=255)),[m
[32m+[m[32m                ('refresh_token', models.CharField(max_length=255)),[m
[32m+[m[32m                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='eve_token', to=settings.AUTH_USER_MODEL)),[m
[32m+[m[32m            ],[m
[32m+[m[32m        ),[m
     ][m
[1mdiff --git a/industry_alert/account/models.py b/industry_alert/account/models.py[m
[1mindex ec96231..f56d1b3 100755[m
[1m--- a/industry_alert/account/models.py[m
[1m+++ b/industry_alert/account/models.py[m
[36m@@ -1,14 +1,28 @@[m
 from django.db import models[m
 from django.contrib.auth.base_user import BaseUserManager, AbstractBaseUser[m
 from django.contrib.auth.models import PermissionsMixin[m
[32m+[m[32mfrom django.conf import settings[m
[32m+[m[32mfrom django.db.models.fields import related[m
[32m+[m[32mfrom django.utils import timezone[m
 [m
 [m
[32m+[m[32mclass EveAccessToken(models.Model):[m
[32m+[m[32m    # fk ë³´ë‹¤ one_to_one ì‚¬ìš©[m
[32m+[m[32m    # one to manyë³´ë‹¤ one to oneì´ ì¡°ì¸ ë¹„ìš© ì ìŒ[m
[32m+[m[32m    user = models.OneToOneField(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="eve_token")[m
[32m+[m[32m    # access_token jwtì¸ë° ì´ê±° ê¸¸ì´ ìƒí•œì´ ì—†ì–´ì„œ char/varcharë¡œ ëª»í•˜ê³  TextFieldë¡œ í•´ì¤˜ì•¼í•¨[m
[32m+[m[32m    access_token = models.TextField()[m
[32m+[m[32m    expires_in = models.DateTimeField(default=timezone.now)[m
[32m+[m[32m    token_type = models.CharField(max_length=255)[m
[32m+[m[32m    refresh_token = models.CharField(max_length=255)[m
[32m+[m
 # https://docs.djangoproject.com/en/3.2/ref/contrib/auth/[m
 class AccountManager(BaseUserManager):[m
     def create_user(self, email, password, name):[m
         if not email:[m
             raise ValueError('Users must have an email address')[m
[31m-        print('ì–´ì¹´ìš´íŠ¸')[m
[32m+[m
[32m+[m
         # ì´ê±° ê·¼ë° ê¼­ í•´ì•¼í•˜ëŠ”ê±´ì§€ëŠ” ëª¨ë¥´ê² ìŒ[m
         user = self.model([m
             # normalize_email()ì´ê±°ëŠ” @domainì—ì„œ domainë§Œ ì†Œë¬¸ìë¡œ ë§Œë“¬[m
[36m@@ -40,11 +54,15 @@[m [mclass AccountManager(BaseUserManager):[m
 # https://medium.com/geekculture/register-login-and-logout-users-in-django-rest-framework-51486390c29[m
 # https://github.com/django/django/blob/910ecd1b8df7678f45c3d507dde6bcb1faafa243/django/contrib/auth/base_user.py#L16 ì°¸ì¡°í•˜ê¸°[m
 # ì—¬ê¸°ì— ì´ë¦„ ìƒë…„ì›”ì¼ ì „í™”ë²ˆí˜¸ ê°™ì€ ê±° ë” ì¶”ê°€í•˜ê¸°[m
[32m+[m
[32m+[m
[32m+[m[32m# ì—¬ê¸°ì—ë‹¤ê°€ eve esi account id ì¶”ê°€í•´ì•¼í•¨ ê·¸ë˜ì•¼ì§€ ê·¸ê±°ê°€ì§€ê³  esi requestí•¨[m
 class User(AbstractBaseUser, PermissionsMixin):[m
     email = models.EmailField(verbose_name="email", max_length=60, unique=True, default=None)[m
     password = models.CharField(verbose_name='password', max_length=255)[m
     # charfieldëŠ” null trueí•˜ëŠ”ê±°ì•„ë‹˜ ê°’ì´ ë¹„ì–´ìˆë‹¤ë¥¼ í‘œì‹œí•˜ëŠ”ê²Œ ë¹ˆìŠ¤íŠ¸ë§ì´ë‘ null ë‘ê°€ì§€ê°€ ë‹¤ë˜ë©´ì„œ ê³±ì°½ë‚¨[m
     name = models.CharField(verbose_name='name', max_length=30, default='', blank=True)[m
[32m+[m[32m    character_id = models.IntegerField(verbose_name='character_id', default=0, blank=True)[m
     is_admin = models.BooleanField(default=False)[m
     is_superuser = models.BooleanField(default=False)[m
 [m
[36m@@ -62,4 +80,4 @@[m [mclass User(AbstractBaseUser, PermissionsMixin):[m
         return self.is_admin[m
 [m
     def __str__(self):[m
[31m-        return str(self.email)[m
\ No newline at end of file[m
[32m+[m[32m        return str(self.email)[m
[1mdiff --git a/industry_alert/account/serializers.py b/industry_alert/account/serializers.py[m
[1mindex 2d98842..83b0326 100644[m
[1m--- a/industry_alert/account/serializers.py[m
[1m+++ b/industry_alert/account/serializers.py[m
[36m@@ -1,5 +1,6 @@[m
[32m+[m[32mfrom requests.api import get[m
 from rest_framework import serializers[m
[31m-from .models import User[m
[32m+[m[32mfrom .models import User, EveAccessToken[m
 from django.contrib.auth import get_user_model[m
 from rest_framework.authtoken.models import Token[m
 # get_user_model() : í´ë˜ìŠ¤ì´ë‹¤.[m
[36m@@ -13,6 +14,48 @@[m [mfrom rest_framework.authtoken.models import Token[m
 # exceptions[m
 class InvalidPassword(Exception):[m
     pass[m
[32m+[m
[32m+[m[32m# class EsiIndustryJobs(serializers.ModelSerializer):[m
[32m+[m
[32m+[m[32m#     class Meta:[m
[32m+[m[32m#         model = IndustryJobs[m
[32m+[m
[32m+[m
[32m+[m
[32m+[m[32mclass EveUserSerializer(serializers.Serializer):[m
[32m+[m[32m    email = serializers.CharField(write_only=True)[m
[32m+[m[32m    name = serializers.CharField(write_only=True)[m
[32m+[m[32m    password = serializers.CharField(write_only=True)[m
[32m+[m[32m    character_id = serializers.IntegerField(write_only=True)[m
[32m+[m
[32m+[m[32m# https://stackoverflow.com/questions/42314882/drf-onetoonefield-create-serializer[m
[32m+[m[32mclass EveAccessTokenSerializer(serializers.Serializer):[m
[32m+[m[32m    # required=TrueëŠ” defaultì„[m
[32m+[m[32m    # ì´ê±° ëŒë ¤ì¤„ í•„ìš”ì—†ìŒ[m
[32m+[m[32m    user = EveUserSerializer(write_only=True)[m
[32m+[m[32m    # ì—¬ê¸° token ë„£ì–´ì¤˜ì•¼ì§€ create()ì—ì„œ ë¦¬í„´í•´ì¤„ ìˆ˜ ìˆìŒ ì•„ë‹ˆë©´ serializeë¥¼ ëª»í•¨[m
[32m+[m[32m    token = serializers.CharField(read_only=True)[m
[32m+[m[32m    created = serializers.BooleanField(read_only=True)[m
[32m+[m
[32m+[m[32m    class Meta:[m
[32m+[m[32m        model = EveAccessToken[m
[32m+[m[32m        fields = ['id', 'user', 'access_token', 'expires_in', 'token_type', 'refresh_token', 'token'][m
[32m+[m
[32m+[m[32m    def create(self, validated_data):[m
[32m+[m[32m        user_data = validated_data.pop('user')[m
[32m+[m[32m        print(user_data)[m
[32m+[m[32m        user_email = user_data.pop('email')[m
[32m+[m[32m        # ê³„ì •ì„ kwargsë¡œ ì°¾ê³  ê³„ì •ì´ ì—†ìœ¼ë©´ kwargsë‘ defaults ë‘˜ ë‹¤ ì´ìš©í•´ì„œ ìƒì„±í•´ì¤Œ[m
[32m+[m[32m        user_instance, _= User.objects.get_or_create(email=user_email, defaults=user_data)[m
[32m+[m[32m        # ë‚´ í† í° ë°œê¸‰[m
[32m+[m[32m        token, _ = Token.objects.get_or_create(user=user_instance)[m
[32m+[m[32m        # EAT updateí•˜ê±°ë‚˜ ìƒì„±[m
[32m+[m[32m        EveAccessToken.objects.update_or_create(user=user_instance, defaults=validated_data)[m
[32m+[m
[32m+[m[32m        # ì—¬ê¸°ì„œ return í•˜ëŠ” instanceë‘ ì‹œë¦¬ì–¼ë¼ì´ì €ì˜ fieldë¥¼ ê¸°ë°˜ìœ¼ë¡œ serializer.dataê°€ ë§Œë“¤ì–´ì§ ì—¬ê¸°ì„œ íŠœí”Œë¦¬í„´í•˜ëŠ”ë° ì—†ëŠ”ê²ƒë“¤ ìˆì–´ì„œ ì•ˆê°€ì§€ëŠ”ê±°ì„[m
[32m+[m[32m        #   return instance, user_instance, updated, 201, {"token": token.key}[m
[32m+[m[32m        return {"token": token.key}[m
[32m+[m
 # drf[m
 # 1. Serializerë¥¼ ìƒì†ë°›ì€ LoginSerializer, ê·¸ë¦¬ê³  ModelSerializerë¥¼ ìƒì†ë°›ì€ UserSerializer ë‘ ê°œ ì‘ì„±[m
 # 2. ê° serializerëŠ” ì•„ë˜ì™€ ê°™ì€ fieldë¥¼ ê°€ì§€ê³  ì´ë¦„ì— ë§ëŠ” ë™ì‘ì„ í•´ì•¼í•¨[m
[36m@@ -24,6 +67,7 @@[m [mclass InvalidPassword(Exception):[m
 class LoginSerializer(serializers.Serializer):[m
     # write_onlyëŠ” ê°’ì„ ë°›ì•„ì„œ create/updateê°™ì€ê±°ë§Œ í•˜ëŠ”ê±°ì„[m
     email = serializers.CharField(write_only=True)[m
[32m+[m[32m    # required=False[m
     password = serializers.CharField(write_only=True)[m
     # ì…ë ¥ë°›ëŠ”ê²Œ ì•„ë‹ˆë¼ returnìœ¼ë¡œ ëŒë ¤ì£¼ëŠ” ê°’ì´ë‹ˆê¹Œ read_onlyì„[m
     token = serializers.CharField(read_only=True)[m
[36m@@ -63,12 +107,12 @@[m [mclass LoginSerializer(serializers.Serializer):[m
 #     ì½ê¸°ì „ìš© : token[m
 #     ë™ì‘ : ë°›ì€ userì •ë³´ë¥¼ í†µí•´ Userë¥¼ ìƒì„±í•˜ê³ , ìƒì„±ëœ userì˜ tokenì„ ìƒˆë¡œ ë°œí–‰í•´ì„œ passwordë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì •ë³´ì™€ í•¨ê»˜ ëŒë ¤ì¤Œ[m
 class UserSerializer(serializers.ModelSerializer):[m
[31m-    password = serializers.CharField(write_only=True)[m
[32m+[m[32m    password = serializers.CharField(write_only=True, required=False)[m
     token = serializers.CharField(read_only=True)[m
 [m
     class Meta:[m
         model = get_user_model()[m
[31m-        fields = ['email', 'password', 'name', 'token'][m
[32m+[m[32m        fields = ['email', 'password', 'name', 'character_id', 'token'][m
 [m
     # ì´ê±° ê·¼ë° user.mode()ì—ì„œ í•´ì£¼ëŠ”ë° ì—†ì–´ì•¼í•˜ëŠ”ê±° ê°™ìŒ[m
     # overrideí•˜ëŠ”ê±°ë‹ˆê¹Œ ì¸ì ë§ì¶°ì¤˜ì•¼í•¨[m
[36m@@ -79,6 +123,7 @@[m [mclass UserSerializer(serializers.ModelSerializer):[m
         # **d means "take all additional named arguments to this function[m
         # and insert them into this parameter as dictionary entries."[m
         # ì´ê±° create_userê°€ ì¸ìë¥¼ 2ê°œ ë°›ì•„ì•¼í•˜ë‹ˆ **validated_data[m
[32m+[m[32m        print(validated_data)[m
         user = User.objects.create_user(**validated_data)[m
         # ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒì„±í•œê°’ì´ë‘[m
         # ìƒì„±ëëŠ”ì§€ ê°€ì ¸ì˜¨ê±´ì§€ ì—¬ë¶€ë¥¼[m
[36m@@ -91,7 +136,8 @@[m [mclass UserSerializer(serializers.ModelSerializer):[m
         # ì´ë ‡ê²Œ í•˜ë©´ tokenì´ ì¶”ê°€ê°€ ê°€ëŠ¥í•œê±°ì„[m
         # ì¶”ê°€ë¡œ ê± ê°ì²´ë¥¼ serializeì‹œí‚¤ë©´ ì•„ê¹Œë§í•œ __str__()ê°’ì´ ë“¤ì–´ê°[m
         user.token = token[m
[31m-        return user[m
[32m+[m[32m        # token objectì˜ keyê°€ ì‚¬ìš©í•˜ëŠ” tokenì„[m
[32m+[m[32m        return {"token": token.key}[m
 [m
     def update(self, instance, validated_data):[m
         # items()ì€ key, value íŠœí”ŒìŒì„ íŠœí”Œë¡œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ì„[m
[1mdiff --git a/industry_alert/account/tasks.py b/industry_alert/account/tasks.py[m
[1mnew file mode 100644[m
[1mindex 0000000..f346d33[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/account/tasks.py[m
[36m@@ -0,0 +1,86 @@[m
[32m+[m[32m# Create your tasks here[m
[32m+[m[32mfrom celery import shared_task[m
[32m+[m[32mimport requests[m
[32m+[m[32mfrom esi.serializers import IndustryJobSerializer[m
[32m+[m[32mfrom esi.models import IndustryJob[m
[32m+[m[32mfrom .models import User[m
[32m+[m[32mfrom rest_framework import serializers[m
[32m+[m
[32m+[m
[32m+[m[32m# ì£¼ê¸°ì ìœ¼ë¡œ task calling í•˜ê¸°[m
[32m+[m[32m@shared_task()[m
[32m+[m[32mdef temp_task(a, b):[m
[32m+[m[32m     return a + b[m
[32m+[m
[32m+[m[32m@shared_task()[m
[32m+[m[32mdef periodic_task1():[m
[32m+[m[32m     instance = User.objects.all()[m
[32m+[m
[32m+[m[32m     for user in instance:[m
[32m+[m[32m          # ì´ë¸Œë¥¼ í†µí•´ì„œ ìƒì„±ëœ ê³„ì •ì´ë©´[m
[32m+[m[32m          if user.character_id != 0:[m
[32m+[m[32m               pass[m
[32m+[m
[32m+[m
[32m+[m[32m# ê°±ì‹ í•˜ëŠ” í† í°ìœ¼ë¡œ ìƒˆ í† í° ë°›ì•„ì˜´[m
[32m+[m[32mdef get_new_accesstoken():[m
[32m+[m[32m     pass[m
[32m+[m
[32m+[m[32mdef esi_reqeust(character_id, access_token):[m
[32m+[m
[32m+[m[32m     acc = f'Bearer {access_token}'[m
[32m+[m[32m     # ì²˜ìŒì— ê°€ì§€ê³  ìˆë˜ access tokenìœ¼ë¡œ ì‹œë„ í•´ë´„[m
[32m+[m[32m     try:[m
[32m+[m[32m          url = f'https://esi.evetech.net/latest/characters/{str(character_id)}/industry/jobs/?datasource=tranquility'[m
[32m+[m[32m          res = requests.get([m
[32m+[m[32m               url,[m
[32m+[m[32m               headers={"Authorization": acc}[m
[32m+[m[32m          )[m
[32m+[m[32m          # ì´ê±°í•˜ë©´ ë¦¬ìŠ¤íŠ¸ë¡œì˜´[m
[32m+[m[32m          industry_jobs = res.json()[m
[32m+[m[32m          industry_job_status = industry_jobs[0]['status'][m
[32m+[m
[32m+[m[32m          return industry_jobs[m
[32m+[m[32m     # jobì´ ì—†ìœ¼ë©´ task ì¢…ë£Œ[m
[32m+[m[32m     except IndexError:[m
[32m+[m[32m          return {"status": "there is no industry job"}[m
[32m+[m[32m     except KeyError:[m
[32m+[m[32m          return {"status": "faild to establish connection to eve server"}[m
[32m+[m[32m     except:[m
[32m+[m[32m          # ì´ê²Œ ë§Œë£Œëœê±°ë©´ refresh í•´ì„œ ìƒˆë¡œìš´ê±° ê°€ì ¸ì™€ì•¼í•¨[m
[32m+[m[32m          pass[m
[32m+[m
[32m+[m
[32m+[m[32m# async taskë‹ˆê¹Œ ë¦¬í„´í•´ì¤„ í•„ìš”ì—†ìŒ[m
[32m+[m[32m# ë¦¬í„´í•˜ë©´ celery resutlsì— ì €ì¥ë¨[m
[32m+[m[32m@shared_task()[m
[32m+[m[32mdef get_industry_jobs(character_id, acc, eve_user_email):[m
[32m+[m[32m     # get access token from database[m
[32m+[m
[32m+[m[32m     # esi request[m
[32m+[m[32m     # accê°€ ë§Œë£Œë˜ë©´ ìƒˆë¡œ ë°›ì•„ì˜¤ëŠ” ê³¼ì •ì´ ìˆì–´ì•¼í•´ì„œ ì´ê±°ë¥¼ í•¨ìˆ˜ë¡œ ë§Œë“¤ì–´ì•¼í• ê±°ê°™ìŒ[m
[32m+[m[32m     try:[m
[32m+[m[32m          url = f'https://esi.evetech.net/latest/characters/{str(character_id)}/industry/jobs/?datasource=tranquility'[m
[32m+[m[32m          res = requests.get([m
[32m+[m[32m               url,[m
[32m+[m[32m               headers={"Authorization": acc}[m
[32m+[m[32m          )[m
[32m+[m[32m          # ì´ê±°í•˜ë©´ ë¦¬ìŠ¤íŠ¸ë¡œì˜´[m
[32m+[m[32m          industry_jobs = res.json()[m
[32m+[m[32m          industry_job_status = industry_jobs[0]['status'][m
[32m+[m[32m     # jobì´ ì—†ìœ¼ë©´ task ì¢…ë£Œ[m
[32m+[m[32m     except IndexError:[m
[32m+[m[32m          return {"status": "there is no industry job"}[m
[32m+[m[32m     except KeyError:[m
[32m+[m[32m          return {"status": "faild to establish connection to eve server"}[m
[32m+[m
[32m+[m[32m     user = User.objects.get(email=eve_user_email)[m
[32m+[m[32m     # ì¡ ìƒì„±/ì—…ë°ì´íŠ¸[m
[32m+[m[32m     # many=trueë©´ dictê°€ ì•„ë‹Œ listë¥¼ ë„˜ê²¨ì•¼í•¨[m
[32m+[m[32m     serializer = IndustryJobSerializer(data=industry_jobs, many=True, context={'user': user})[m
[32m+[m[32m     try:[m
[32m+[m[32m          serializer.is_valid(raise_exception=True)[m
[32m+[m[32m          serializer.save()[m
[32m+[m[32m     except serializers.ValidationError:[m
[32m+[m[32m          return {"status": "failed", "errors": serializer.errors}[m
[32m+[m[32m     return serializer.data[m
[1mdiff --git a/industry_alert/account/urls.py b/industry_alert/account/urls.py[m
[1mindex f630833..e196818 100644[m
[1m--- a/industry_alert/account/urls.py[m
[1m+++ b/industry_alert/account/urls.py[m
[36m@@ -8,6 +8,7 @@[m [mfrom rest_framework.routers import DefaultRouter[m
 [m
 router = DefaultRouter(trailing_slash=False)[m
 router.register(r'user', views.AccountViewSet, basename='logins')[m
[32m+[m[32mrouter.register(r'evelogin', views.EveLoginViewSet, basename='evelogins')[m
 [m
 urlpatterns = [[m
     path('api/v1/', include(router.urls)),[m
[1mdiff --git a/industry_alert/account/utils.py b/industry_alert/account/utils.py[m
[1mnew file mode 100644[m
[1mindex 0000000..43499ac[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/account/utils.py[m
[36m@@ -0,0 +1,32 @@[m
[32m+[m[32m# for random passowrd[m
[32m+[m[32mimport string[m
[32m+[m[32mimport secrets[m
[32m+[m[41m [m
[32m+[m[32m # create url for esi request[m
[32m+[m[32mdef url_creator(character_id, scopes):[m
[32m+[m[32m    base_url = 'https://esi.evetech.net/latest/characters/'[m
[32m+[m
[32m+[m[32m    # ì´ê±° ë’¤ì— query string ë–¼ë‚´ì•¼í•¨[m
[32m+[m[32m    esi_scopes = {'industry_jobs': '/industry/jobs/?datasource=tranquility'}[m
[32m+[m
[32m+[m[32m    return base_url + str(character_id) + esi_scopes[scopes][m
[32m+[m[41m    [m
[32m+[m[32mdef email_creator(character_name):[m
[32m+[m[32m    domain = '@eveoline.com'[m
[32m+[m[32m    character_name.replace(" ", "")[m
[32m+[m
[32m+[m[32m    return character_name + domain[m
[32m+[m
[32m+[m[32mdef create_random_string():[m
[32m+[m[32m    alphabet = string.ascii_letters + string.digits[m
[32m+[m[32m    while True:[m
[32m+[m[32m        # ì•ŒíŒŒë²³ ì†Œë¬¸ì 5ê°œ ì´ìƒ[m
[32m+[m[32m        # ì•ŒíŒŒë²³ ëŒ€ë¬¸ì 5ê°œ ì´ìƒ[m
[32m+[m[32m        # ìˆ«ì 3ê°œ ì´ìƒ[m
[32m+[m[32m        password = ''.join(secrets.choice(alphabet) for i in range(20))[m
[32m+[m[32m        if (sum(c.islower() for c in password) >=5[m
[32m+[m[32m            and sum(c.isupper() for c in password) >= 5[m
[32m+[m[32m            and sum(c.isdigit() for c in password) >= 3):[m
[32m+[m[32m            break[m
[32m+[m
[32m+[m[32m    return password[m
\ No newline at end of file[m
[1mdiff --git a/industry_alert/account/views.py b/industry_alert/account/views.py[m
[1mindex 37c670b..f7651b5 100755[m
[1m--- a/industry_alert/account/views.py[m
[1m+++ b/industry_alert/account/views.py[m
[36m@@ -3,8 +3,126 @@[m [mfrom rest_framework.decorators import action[m
 from rest_framework.response import Response[m
 from rest_framework.permissions import AllowAny, IsAuthenticated[m
 from rest_framework.authtoken.models import Token[m
[31m-from .models import User[m
[31m-from .serializers import LoginSerializer, UserSerializer, InvalidPassword[m
[32m+[m[32mfrom .models import EveAccessToken, User[m
[32m+[m[32mfrom .serializers import LoginSerializer, UserSerializer, EveUserSerializer, EveAccessTokenSerializer, InvalidPassword[m
[32m+[m
[32m+[m[32m# eve login[m
[32m+[m[32mimport requests[m
[32m+[m[32mimport base64[m
[32m+[m[32mimport os[m
[32m+[m[32mfrom dotenv import load_dotenv[m
[32m+[m[32mfrom .utils import url_creator, email_creator, create_random_string[m
[32m+[m
[32m+[m[32m# eve access token[m
[32m+[m[32mimport datetime[m
[32m+[m
[32m+[m[32m# celery task[m
[32m+[m[32mfrom .tasks import get_industry_jobs[m
[32m+[m
[32m+[m[32m# ì´ë¸Œ ë¡œê·¸ì¸ ê´€ë ¨[m
[32m+[m[32mclass EveLoginViewSet(viewsets.GenericViewSet):[m
[32m+[m[32m    permission_classes = [AllowAny][m
[32m+[m[32m    queryset = User.objects.all()[m
[32m+[m[32m    serializer_class = EveUserSerializer[m
[32m+[m
[32m+[m[32m    @action(methods=['get'], detail=False)[m
[32m+[m[32m    def callback(self, request):[m
[32m+[m[32m        # get()[m
[32m+[m[32m        # Returns the value for key in the dictionary; if not found returns a default value.[m
[32m+[m[32m        # Optional.[m[41m [m
[32m+[m[32m        # Value that is returned when the key is not found. Defaults to None, so that this method never raises a KeyError.[m
[32m+[m[41m        [m
[32m+[m[32m        # ì €ìª½ì—ì„œ ì´ìª½ìœ¼ë¡œ request ë³´ë‚¸ê±°ëŠ” ì •ìƒìœ¼ë¡œ ê°„ì£¼í•˜ê³  í•´ì•¼í•¨[m
[32m+[m[32m        auth_code = request.GET.get('code')[m
[32m+[m[32m        state = request.GET.get('state')[m
[32m+[m
[32m+[m[32m        # Now that your application has the authorization code,[m[41m [m
[32m+[m[32m        # it needs to send a POST request to[m
[32m+[m[32m        # https://login.eveonline.com/v2/oauth/token[m
[32m+[m[32m        # where your applicationâ€™s client ID will be the user[m
[32m+[m[32m        #  your secret key will be the password[m
[32m+[m[32m        load_dotenv()[m
[32m+[m[32m        client_id = os.getenv('ID')[m
[32m+[m[32m        secret_key = os.getenv('KEY')[m
[32m+[m
[32m+[m[32m        # You will need to send the following HTTP headers (replace anything between <>, including <>)[m
[32m+[m[32m        # Authorization: Basic <URL safe Base64 encoded credentials>[m
[32m+[m[32m        # Content-Type: application/x-www-form-urlencoded[m
[32m+[m[32m        # Host: login.eveonline.com[m
[32m+[m[32m        user_pass = f'{client_id}:{secret_key}'[m
[32m+[m[32m        basic_auth = base64.urlsafe_b64encode(user_pass.encode()).decode()[m
[32m+[m[32m        auth_header = f'Basic {basic_auth}'[m
[32m+[m
[32m+[m[32m        headers = {[m
[32m+[m[32m            "Authorization": auth_header,[m
[32m+[m[32m            "Content-Type": "application/x-www-form-urlencoded",[m
[32m+[m[32m            "Host": "login.eveonline.com",[m
[32m+[m[32m        }[m
[32m+[m[32m        body = {[m
[32m+[m[32m            'grant_type': 'authorization_code',[m
[32m+[m[32m            'code': auth_code[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        # Finally, send a POST request to https://login.eveonline.com/v2/oauth/token with your form encoded values and the headers from the last step.[m
[32m+[m[32m        try:[m
[32m+[m[32m            res = requests.post([m
[32m+[m[32m                'https://login.eveonline.com/v2/oauth/token',[m
[32m+[m[32m                headers=headers,[m
[32m+[m[32m                data=body[m
[32m+[m[32m            )[m
[32m+[m[32m            # If the previous step was done correctly, the EVE SSO will respond with a JSON payload containing an access token (which is a Json Web Token)[m[41m [m
[32m+[m[32m            # and a refresh token that looks like this (Anything wrapped by <> will look different for you):[m
[32m+[m[32m            res_dict = res.json()[m
[32m+[m[32m            # access_token = res_dict.get('access_token')[m
[32m+[m[32m            # get()ì€ defaultë¥¼ return í•˜ë‹ˆë•Œë¬¸ì— keyerrorìƒì„±ì•ˆí•˜ë‹ˆ get()ì´ê±° ì“°ë©´ ì•ˆë¨[m
[32m+[m[32m            access_token = res_dict['access_token'][m
[32m+[m[32m            res_dict['expires_in'] = datetime.datetime.now() + datetime.timedelta(minutes=19, seconds=59)[m
[32m+[m[32m            # ì´ê±° ì–´ì°¨í”¼ ì—¬ê¸°ì„œ access_tokenì´ ì•ˆì˜¨ê±°ë©´ ì—°ê²°ì´  ì‹¤íŒ¨í•œê±°ì„[m
[32m+[m[32m            # ê·¸ëŸ¬ë‹ˆê¹Œ ì˜ˆì™¸ëŠ” ì—¬ê¸°ì„œ keyErrorí•˜ë‚˜ë§Œ ì¡ê³  ë‚˜ë¨¸ì§€ ë‹¤ë¥¸ ì—ëŸ¬ëŠ”[m
[32m+[m[32m            # djangoì—ì„œ 500ì—ëŸ¬ ì£¼ë‹ˆ ì´ê±° logging í•´ì„œ ì¡ì•„ë‚´ë©´ë¨[m
[32m+[m[32m            # í´ë¼ì´ì–¸íŠ¸ëŠ” ì¡ë‹¤í•œ ì˜ˆì™¸ ìƒí™© ì•Œ í•„ìš”ì—†ê³  ì—¬ê¸° ê¸°ì¤€ìœ¼ë¡œëŠ” ì´ë¸Œì™€ì˜ ì„œë²„ í†µì‹ ì„ ì‹¤íŒ¨í•œê±°ë§Œ ì•Œë©´ ë˜ê¸° ë–„ë¬¸ì—[m
[32m+[m[32m            # ê·¸ëƒ¥ access_token ì—†ìœ¼ë©´ ì´ë¸Œ ì„œë²„ì™€ì˜ í†µì‹ ì´ ì‹¤íŒ¨í•œê±°ë‹ˆ ì‹¤íŒ¨í–ˆë‹¤ê³  ì•Œë ¤ì£¼ë©´ë¨.[m
[32m+[m[32m        except KeyError:[m
[32m+[m[32m            return Response({"status": "failed", "errors": "ì´ë¸Œì„œë²„ì™€ í†µì‹ ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."})[m
[32m+[m
[32m+[m[32m        # ì—¬ê¸°ì„œ ë§í•˜ëŠ” JSON payloadê°€ ìœ„ì˜ resì— ì €ì¥ë¨[m
[32m+[m
[32m+[m[32m        # access_tokenìœ¼ë¡œ eve character name ê°€ì ¸ì˜´[m
[32m+[m[32m        acc = f'Bearer {access_token}'[m
[32m+[m[32m        try:[m
[32m+[m[32m            character_res = requests.get([m
[32m+[m[32m                "https://login.eveonline.com/oauth/verify",[m
[32m+[m[32m                headers={"Authorization": acc}[m
[32m+[m[32m            )[m
[32m+[m[32m            character_dict = character_res.json()[m
[32m+[m[32m            character_id = character_dict['CharacterID'][m
[32m+[m[32m        except KeyError:[m
[32m+[m[32m            return Response({"status": "failed", "errors": "ì´ë¸Œì„œë²„ì™€ í†µì‹ ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."})[m
[32m+[m
[32m+[m[32m        # create django user and return its token[m
[32m+[m[32m        # eve_user = {} ì´ë ‡ê²Œ í•˜ëŠ”ê±°ë³´ë‹¤ {}ì´ set, dictionary ë‘˜ ë‹¤ì—¬ì„œ dict()í•´ì£¼ëŠ”ê²Œ ì¢‹ìŒ[m
[32m+[m[32m        eve_user = dict()[m
[32m+[m[32m        eve_user_email = email_creator(character_dict['CharacterName'])[m
[32m+[m[32m        eve_user['email'] = eve_user_email[m
[32m+[m[32m        eve_user['name'] = character_dict['CharacterName'][m
[32m+[m[32m        eve_user['password'] = create_random_string()[m
[32m+[m[32m        eve_user['character_id'] = character_id[m
[32m+[m
[32m+[m[32m        temp_dict = res_dict.copy()[m
[32m+[m[32m        temp_dict['user'] = eve_user[m
[32m+[m
[32m+[m[32m        # EveAccessToken ì €ì¥[m
[32m+[m[32m        serializer = EveAccessTokenSerializer(data=temp_dict)[m
[32m+[m[32m        try:[m
[32m+[m[32m            serializer.is_valid(raise_exception=True)[m
[32m+[m[32m            serializer.save()[m
[32m+[m
[32m+[m[32m            # celeryë¡œ job ë°›ì•„ì˜¤ê¸°[m
[32m+[m[32m            get_industry_jobs.delay(character_id, acc, eve_user_email)[m
[32m+[m[32m            return Response(serializer.data, status=status.HTTP_201_CREATED)[m
[32m+[m
[32m+[m[32m        except serializers.ValidationError:[m
[32m+[m[32m            return Response({"status": "failed login user via eve account", "errors": serializer.errors})[m
 [m
 # drf login[m
 # https://stackoverflow.com/questions/26906630/django-rest-framework-authentication-credentials-were-not-provided ì´ê±° ì§€ê¸ˆ í•´ê²°ì•ˆë˜ê³ ìˆìŒ[m
[36m@@ -78,19 +196,36 @@[m [mclass AccountViewSet(viewsets.GenericViewSet):[m
     # /api/v1/user ë¡œ POSTìš”ì²­ì„ ë°›ì„ registration api (UserSerializer ì‚¬ìš©)[m
     # http POST http://127.0.0.1:8000/api/v1/user/register email="id@gmail.com" password="pw"[m
     @action(detail=False, methods=['post'], permission_classes=[AllowAny])[m
[31m-    def register(self, request):[m
[31m-        serializer = self.get_serializer(data=request.data)[m
[31m-        try:[m
[31m-            serializer.is_valid(raise_exception=True)[m
[31m-            # ì´ê±° save()í–ˆì„ë•Œ ë¶ˆë ¤ì˜¤ëŠ” methodëŠ”[m
[31m-            # serializer = UserSerializer(data=request.data)ì—ì„œ dataì•ì— ë­ê°€ ì—†ìœ¼ë©´[m
[31m-            # UserSerializer.create()ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ê±°ì„[m
[31m-            serializer.save()[m
[31m-            # ì´ê±° pwëŠ” write_onlyë¼ì„œ ì•ˆë³´ì„[m
[31m-            print(serializer.data)[m
[31m-            return Response(serializer.data)[m
[31m-        except serializers.ValidationError:[m
[31m-            return Response({"status": "failed", "errors": serializer.errors})[m
[32m+[m[32m    def register(self, request, eve_user=None):[m
[32m+[m[32m        print("in register")[m
[32m+[m[32m        print(eve_user)[m
[32m+[m[32m        if eve_user:[m
[32m+[m[32m            serializer = self.get_serializer(data=eve_user)[m
[32m+[m[32m            try:[m
[32m+[m[32m                serializer.is_valid(raise_exception=True)[m
[32m+[m[32m                # ì´ê±° save()í–ˆì„ë•Œ ë¶ˆë ¤ì˜¤ëŠ” methodëŠ”[m
[32m+[m[32m                # serializer = UserSerializer(data=request.data)ì—ì„œ dataì•ì— ë­ê°€ ì—†ìœ¼ë©´[m
[32m+[m[32m                # UserSerializer.create()ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ê±°ì„[m
[32m+[m[32m                serializer.save()[m
[32m+[m[32m                # ì´ê±° pwëŠ” write_onlyë¼ì„œ ì•ˆë³´ì„[m
[32m+[m[32m                print("in register2")[m
[32m+[m[32m                print(serializer.data)[m
[32m+[m[32m                return Response(serializer.data)[m
[32m+[m[32m            except serializers.ValidationError:[m
[32m+[m[32m                return Response({"status": "failed", "errors": serializer.errors})[m
[32m+[m[32m        else:[m[41m [m
[32m+[m[32m            serializer = self.get_serializer(data=request.data)[m
[32m+[m[32m            try:[m
[32m+[m[32m                serializer.is_valid(raise_exception=True)[m
[32m+[m[32m                # ì´ê±° save()í–ˆì„ë•Œ ë¶ˆë ¤ì˜¤ëŠ” methodëŠ”[m
[32m+[m[32m                # serializer = UserSerializer(data=request.data)ì—ì„œ dataì•ì— ë­ê°€ ì—†ìœ¼ë©´[m
[32m+[m[32m                # UserSerializer.create()ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ê±°ì„[m
[32m+[m[32m                serializer.save()[m
[32m+[m[32m                # ì´ê±° pwëŠ” write_onlyë¼ì„œ ì•ˆë³´ì„[m
[32m+[m[32m                print(serializer.data)[m
[32m+[m[32m                return Response(serializer.data)[m
[32m+[m[32m            except serializers.ValidationError:[m
[32m+[m[32m                return Response({"status": "failed", "errors": serializer.errors})[m
 [m
     # /api/v1/user/login ìœ¼ë¡œ POSTìš”ì²­ì„ ë°›ì„ login api (LoginSerializer ì‚¬ìš©)[m
     # http POST http://127.0.0.1:8000/api/v1/user/login email="id@gmail.com" password="pw"[m
[36m@@ -118,4 +253,4 @@[m [mclass AccountViewSet(viewsets.GenericViewSet):[m
 [m
         return Response({'success': "ë¡œê·¸ì•„ì›ƒ ì„±ê³µ"}, status=status.HTTP_200_OK)[m
 [m
[31m-    # íŠ¹ì • ìœ ì €ê°€ publish í•œ post ë³´ê¸°[m
\ No newline at end of file[m
[32m+[m[32m    # íŠ¹ì • ìœ ì €ê°€ publish í•œ post ë³´ê¸°[m
[1mdiff --git a/industry_alert/blog/migrations/0001_initial.py b/industry_alert/blog/migrations/0001_initial.py[m
[1mindex 80415cd..3f4f55d 100644[m
[1m--- a/industry_alert/blog/migrations/0001_initial.py[m
[1m+++ b/industry_alert/blog/migrations/0001_initial.py[m
[36m@@ -1,4 +1,4 @@[m
[31m-# Generated by Django 3.2.5 on 2021-11-06 10:28[m
[32m+[m[32m# Generated by Django 3.2.5 on 2021-11-23 09:11[m
 [m
 import blog.models[m
 from django.conf import settings[m
[1mdiff --git a/industry_alert/blog/serializers.py b/industry_alert/blog/serializers.py[m
[1mindex 4e4277e..98b58f3 100644[m
[1m--- a/industry_alert/blog/serializers.py[m
[1m+++ b/industry_alert/blog/serializers.py[m
[36m@@ -61,13 +61,14 @@[m [mclass CommentSerializer(serializers.ModelSerializer):[m
     # ì´ related fieldë“¤ì´ fk constraintë§ê³ ë„ ì‹¤ì œë¡œ ì¹¼ëŸ¼ì´ë¦„ì´ post_idë¡œ ì €ì¥ë˜ì–´ ìˆìŒ[m
     # post_idê°™ì´ (related_fieldì´ë¦„)_id ì´ëŸ°ì‹ìœ¼ë¡œ ì‹¤ì œ dbì— ê¸°ë¡ëŒ€ê³ [m
     # ì´ê²Œ ë³¸ì²´ì¸ê±°ê³  ì €ëŸ° post ê°™ì€ê²Œ ì¥ê³ ê°€ ì•Œì•„ì„œ í•´ì£¼ëŠ” ë¶€ë¶„ì¸ë°[m
[32m+[m[32m    # ë°‘ì— ì´ê±° ì—†ì–´ë„ë˜ëŠ”ê±°ê°™ì€ë° ë¬¼ì–´ë³´ê¸°[m
     post_id = serializers.PrimaryKeyRelatedField(queryset=Post.objects.all(), required=False)[m
 [m
     class Meta:[m
         model = Comment[m
         fields = ['id', 'post_id', 'author', 'text', 'created_date', 'approved_comment'][m
 [m
[31m-    #  is_validê°€ 3ê°€ì§€ ê²€ì‚¬ë¥¼ í•¨[m
[32m+[m[32m    # is_validê°€ 3ê°€ì§€ ê²€ì‚¬ë¥¼ í•¨[m
     # modelì— ì •ì˜ëœê±°ë‘ íƒ€ì…ì´ ë§ëŠ”ì§€ í•„ë“œë³„ë¡œ ê²€ì‚¬ í•œ ë²ˆ ë‹¤ í•˜ê³ [m
     # serializerì— validate_í•„ë“œì´ë¦„ ì´ë ‡ê²Œ ì •ì˜í•œ í•¨ìŠ¤ë“¤ ì½”ë“œì—ì„œ íŒŒì‹±í•´ì„œ ì € í•¨ìˆ˜ë“¤ í•œë²ˆì”© ë‹¤ ëŒë ¤ì£¼ê³ [m
     # ê° í•„ë“œì— ëŒ€í•œ ì¶”ê°€ì ì¸ validationì„[m
[1mdiff --git a/industry_alert/blog/urls.py b/industry_alert/blog/urls.py[m
[1mindex 51b14b4..c0d6470 100644[m
[1m--- a/industry_alert/blog/urls.py[m
[1m+++ b/industry_alert/blog/urls.py[m
[36m@@ -16,7 +16,6 @@[m [mrouter = DefaultRouter(trailing_slash=False)[m
 # create apiëŠ” post-create[m
 router.register(r'post', views.PostViewSet2, basename='posts')[m
 router.register(r'comment', views.CommentViewSet, basename='comments')[m
[31m-router.register(r'evelogin', views.EveLoginViewSet, basename='evelogins')[m
 [m
 urlpatterns = [[m
 	# YOUR PATTERNS[m
[1mdiff --git a/industry_alert/blog/views.py b/industry_alert/blog/views.py[m
[1mindex 5397489..3450358 100644[m
[1m--- a/industry_alert/blog/views.py[m
[1m+++ b/industry_alert/blog/views.py[m
[36m@@ -33,121 +33,6 @@[m [mfrom .models import EntryImage[m
 from .serializers import ImageSerializer[m
 from django.contrib.contenttypes.models import ContentType[m
 [m
[31m-# eve login[m
[31m-import requests[m
[31m-import base64[m
[31m-from dotenv import load_dotenv[m
[31m-import os[m
[31m-# ì´ë¸Œ ë¡œê·¸ì¸ ê´€ë ¨[m
[31m-class EveLoginViewSet(viewsets.GenericViewSet):[m
[31m-    permission_classes = [AllowAny][m
[31m-[m
[31m-    # create url for esi request[m
[31m-    def url_creater(self, character_id, scopes):[m
[31m-        base_url = 'https://esi.evetech.net/latest/characters/'[m
[31m-[m
[31m-        # ì´ê±° ë’¤ì— query string ë–¼ë‚´ì•¼í•¨[m
[31m-        esi_scopes = {'industry_jobs': '/industry/jobs/?datasource=tranquility'}[m
[31m-[m
[31m-        return base_url + str(character_id) + esi_scopes[scopes][m
[31m-[m
[31m-    @action(methods=['get'], detail=False, url_path='redirect')[m
[31m-    def get_users_published_posts(self, request):[m
[31m-        print(count_widgets.delay())[m
[31m-        # ì´ê±° stateëŠ” ì›ë˜ randomí•œ  ìŠ¤íŠ¸ë§ ë„£ì–´ì•¼í•˜ëŠ”ë° ì§€ê¸ˆì€ ê·¸ëƒ¥ ê±í•¨[m
[31m-        return redirect('https://login.eveonline.com/v2/oauth/authorize/? \[m
[31m-                         response_type=code \[m
[31m-                         & \[m
[31m-                         redirect_uri=http%3A%2F%2F13.124.169.90%3A8000%2Fapi%2Fv1%2Fevelogin%2Fcallback \[m
[31m-                         & \[m
[31m-                         client_id=8e86edc0f4ee45b6a5f70cdba2f01ea7 \[m
[31m-                         & \[m
[31m-                         scope=esi-industry.read_character_jobs.v1 \[m
[31m-                         & \[m
[31m-                         state=3sooham')[m
[31m-[m
[31m-    @action(methods=['get'], detail=False)[m
[31m-    def callback(self, request):[m
[31m-        # get()[m
[31m-        # Returns the value for key in the dictionary; if not found returns a default value.[m
[31m-        # Optional. [m
[31m-        # Value that is returned when the key is not found. Defaults to None, so that this method never raises a KeyError.[m
[31m-        [m
[31m-        # ì €ìª½ì—ì„œ ì´ìª½ìœ¼ë¡œ request ë³´ë‚¸ê±°ëŠ” ì •ìƒìœ¼ë¡œ ê°„ì£¼í•˜ê³  í•´ì•¼í•¨[m
[31m-        auth_code = request.GET.get('code')[m
[31m-        state = request.GET.get('state')[m
[31m-[m
[31m-        # Now that your application has the authorization code, [m
[31m-        # it needs to send a POST request to[m
[31m-        # https://login.eveonline.com/v2/oauth/token[m
[31m-        # where your applicationâ€™s client ID will be the user[m
[31m-        #  your secret key will be the password[m
[31m-        load_dotenv()[m
[31m-        client_id = os.getenv('ID')[m
[31m-        secret_key = os.getenv('KEY')[m
[31m-[m
[31m-        # You will need to send the following HTTP headers (replace anything between <>, including <>)[m
[31m-        # Authorization: Basic <URL safe Base64 encoded credentials>[m
[31m-        # Content-Type: application/x-www-form-urlencoded[m
[31m-        # Host: login.eveonline.com[m
[31m-        user_pass = f'{client_id}:{secret_key}'[m
[31m-        basic_auth = base64.urlsafe_b64encode(user_pass.encode()).decode()[m
[31m-        auth_header = f'Basic {basic_auth}'[m
[31m-[m
[31m-        headers = {[m
[31m-            "Authorization": auth_header,[m
[31m-            "Content-Type": "application/x-www-form-urlencoded",[m
[31m-            "Host": "login.eveonline.com",[m
[31m-        }[m
[31m-        body = {[m
[31m-            'grant_type': 'authorization_code',[m
[31m-            'code': auth_code[m
[31m-        }[m
[31m-[m
[31m-        # Finally, send a POST request to https://login.eveonline.com/v2/oauth/token with your form encoded values and the headers from the last step.[m
[31m-        try:[m
[31m-            res = requests.post([m
[31m-                'https://login.eveonline.com/v2/oauth/token',[m
[31m-                headers=headers,[m
[31m-                data=body[m
[31m-            )[m
[31m-            res_dict = res.json()[m
[31m-            access_token = res_dict.get('access_token')[m
[31m-            # ì´ê±° ì–´ì°¨í”¼ ì—¬ê¸°ì„œ access_tokenì´ ì•ˆì˜¨ê±°ë©´ ì—°ê²°ì´  ì‹¤íŒ¨í•œê±°ì„[m
[31m-            # ê·¸ëŸ¬ë‹ˆê¹Œ ì˜ˆì™¸ëŠ” ì—¬ê¸°ì„œ keyErrorí•˜ë‚˜ë§Œ ì¡ê³  ë‚˜ë¨¸ì§€ ë‹¤ë¥¸ ì—ëŸ¬ëŠ”[m
[31m-            # djangoì—ì„œ 500ì—ëŸ¬ ì£¼ë‹ˆ ì´ê±° logging í•´ì„œ ì¡ì•„ë‚´ë©´ë¨[m
[31m-            # í´ë¼ì´ì–¸íŠ¸ëŠ” ì¡ë‹¤í•œ ì˜ˆì™¸ ìƒí™© ì•Œ í•„ìš”ì—†ê³  ì—¬ê¸° ê¸°ì¤€ìœ¼ë¡œëŠ” ì´ë¸Œì™€ì˜ ì„œë²„ í†µì‹ ì„ ì‹¤íŒ¨í•œê±°ë§Œ ì•Œë©´ ë˜ê¸° ë–„ë¬¸ì—[m
[31m-            # ê·¸ëƒ¥ access_token ì—†ìœ¼ë©´ ì´ë¸Œ ì„œë²„ì™€ì˜ í†µì‹ ì´ ì‹¤íŒ¨í•œê±°ë‹ˆ ì‹¤íŒ¨í–ˆë‹¤ê³  ì•Œë ¤ì£¼ë©´ë¨.[m
[31m-        except KeyError:[m
[31m-            return Response({"status": "failed", "errors": "ì´ë¸Œì„œë²„ì™€ í†µì‹ ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."})[m
[31m-[m
[31m-        # If the previous step was done correctly, the EVE SSO will respond with a JSON payload containing an access token (which is a Json Web Token) [m
[31m-        # and a refresh token that looks like this (Anything wrapped by <> will look different for you):[m
[31m-        # ì—¬ê¸°ì„œ ë§í•˜ëŠ” JSON payloadê°€ ìœ„ì˜ resì— ì €ì¥ë¨[m
[31m-        acc = 'Bearer ' + access_token[m
[31m-        try:[m
[31m-            character_res = requests.get([m
[31m-                "https://login.eveonline.com/oauth/verify",[m
[31m-                headers={"Authorization": acc}[m
[31m-            )[m
[31m-            character_dict = character_res.json()[m
[31m-            character_id = character_dict['CharacterID'][m
[31m-        except KeyError:[m
[31m-            return Response({"status": "failed", "errors": "ì´ë¸Œì„œë²„ì™€ í†µì‹ ì„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."})[m
[31m-[m
[31m-        esi_request_url = self.url_creater(character_id, 'industry_jobs')[m
[31m-        [m
[31m-        res4 = requests.get([m
[31m-             esi_request_url,[m
[31m-             headers= {'Authorization': acc}[m
[31m-        )[m
[31m-[m
[31m-        dd = res4.json()[m
[31m-[m
[31m-        # create django user and return its token[m
[31m-[m
[31m-        return Response({"ë„ˆëŠ”": dd})[m
[31m-[m
 # drf viewset[m
 class PostViewSet(viewsets.ModelViewSet):[m
     queryset = Post.objects.all()[m
[36m@@ -211,7 +96,7 @@[m [mclass PostViewSet2(viewsets.GenericViewSet):[m
     def add_image(self, instance, request):[m
         try:[m
             #  fields = ['id', 'image', 'content_type', 'object_id'][m
[31m-            import pdb; pdb.set_trace()[m
[32m+[m[32m            # import pdb; pdb.set_trace()[m
             # verbose_name ì˜µì…˜ì„ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ CamelCase í´ë˜ìŠ¤ ì´ë¦„ì„ ê¸°ì¤€ìœ¼ë¡œ camel case ì´ì™€ ê°™ì´ ëª¨ë‘ ì†Œë¬¸ìë¡œ ë³€ê²½í•œë‹¤.[m
             # https://wikidocs.net/6667#verbose_name[m
             # user_type = ContentType.objects.get(app_label='blog', model='post')[m
[1mdiff --git a/industry_alert/esi/__init__.py b/industry_alert/esi/__init__.py[m
[1mnew file mode 100644[m
[1mindex 0000000..e69de29[m
[1mdiff --git a/industry_alert/esi/admin.py b/industry_alert/esi/admin.py[m
[1mnew file mode 100644[m
[1mindex 0000000..4e3e4a2[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/esi/admin.py[m
[36m@@ -0,0 +1,5 @@[m
[32m+[m[32mfrom django.contrib import admin[m
[32m+[m[32mfrom .models import IndustryJob[m
[32m+[m[32m# Register your models here.[m
[32m+[m
[32m+[m[32madmin.site.register(IndustryJob)[m
[1mdiff --git a/industry_alert/esi/apps.py b/industry_alert/esi/apps.py[m
[1mnew file mode 100644[m
[1mindex 0000000..051dafd[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/esi/apps.py[m
[36m@@ -0,0 +1,6 @@[m
[32m+[m[32mfrom django.apps import AppConfig[m
[32m+[m
[32m+[m
[32m+[m[32mclass EsiConfig(AppConfig):[m
[32m+[m[32m    default_auto_field = 'django.db.models.BigAutoField'[m
[32m+[m[32m    name = 'esi'[m
[1mdiff --git a/industry_alert/esi/migrations/0001_initial.py b/industry_alert/esi/migrations/0001_initial.py[m
[1mnew file mode 100644[m
[1mindex 0000000..8be7a29[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/esi/migrations/0001_initial.py[m
[36m@@ -0,0 +1,46 @@[m
[32m+[m[32m# Generated by Django 3.2.5 on 2021-11-23 09:11[m
[32m+[m
[32m+[m[32mfrom django.conf import settings[m
[32m+[m[32mfrom django.db import migrations, models[m
[32m+[m[32mimport django.db.models.deletion[m
[32m+[m
[32m+[m
[32m+[m[32mclass Migration(migrations.Migration):[m
[32m+[m
[32m+[m[32m    initial = True[m
[32m+[m
[32m+[m[32m    dependencies = [[m
[32m+[m[32m        migrations.swappable_dependency(settings.AUTH_USER_MODEL),[m
[32m+[m[32m    ][m
[32m+[m
[32m+[m[32m    operations = [[m
[32m+[m[32m        migrations.CreateModel([m
[32m+[m[32m            name='IndustryJob',[m
[32m+[m[32m            fields=[[m
[32m+[m[32m                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),[m
[32m+[m[32m                ('activity_id', models.IntegerField(null=True)),[m
[32m+[m[32m                ('blueprint_id', models.BigIntegerField(null=True)),[m
[32m+[m[32m                ('blueprint_location_id', models.BigIntegerField(null=True)),[m
[32m+[m[32m                ('blueprint_type_id', models.BigIntegerField(null=True)),[m
[32m+[m[32m                ('completed_character_id', models.IntegerField(null=True)),[m
[32m+[m[32m                ('completed_data', models.DateTimeField(null=True)),[m
[32m+[m[32m                ('cost', models.DecimalField(decimal_places=4, max_digits=13, null=True)),[m
[32m+[m[32m                ('duration', models.IntegerField(null=True)),[m
[32m+[m[32m                ('end_date', models.DateTimeField(null=True)),[m
[32m+[m[32m                ('facility_id', models.BigIntegerField(null=True)),[m
[32m+[m[32m                ('installer_id', models.IntegerField(null=True)),[m
[32m+[m[32m                ('job_id', models.IntegerField(null=True)),[m
[32m+[m[32m                ('licensed_runs', models.IntegerField(null=True)),[m
[32m+[m[32m                ('output_location_id', models.BigIntegerField(null=True)),[m
[32m+[m[32m                ('pause_date', models.DateTimeField(null=True)),[m
[32m+[m[32m                ('probability', models.FloatField(null=True)),[m
[32m+[m[32m                ('product_type_id', models.IntegerField(null=True)),[m
[32m+[m[32m                ('runs', models.IntegerField(null=True)),[m
[32m+[m[32m                ('start_date', models.DateTimeField(null=True)),[m
[32m+[m[32m                ('station_id', models.BigIntegerField(null=True)),[m
[32m+[m[32m                ('status', models.CharField(choices=[('active', 'Active'), ('cancelled', 'Cancelled'), ('delivered', 'Delivered'), ('paused', 'Paused'), ('ready', 'Ready'), ('reverted', 'Reverted')], max_length=10)),[m
[32m+[m[32m                ('successful_runs', models.IntegerField(null=True)),[m
[32m+[m[32m                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='indsutry_jobs', to=settings.AUTH_USER_MODEL)),[m
[32m+[m[32m            ],[m
[32m+[m[32m        ),[m
[32m+[m[32m    ][m
[1mdiff --git a/industry_alert/esi/migrations/__init__.py b/industry_alert/esi/migrations/__init__.py[m
[1mnew file mode 100644[m
[1mindex 0000000..e69de29[m
[1mdiff --git a/industry_alert/esi/models.py b/industry_alert/esi/models.py[m
[1mnew file mode 100644[m
[1mindex 0000000..2892a80[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/esi/models.py[m
[36m@@ -0,0 +1,78 @@[m
[32m+[m[32mfrom django.db import models[m
[32m+[m[32mfrom django.conf import settings[m
[32m+[m[32mfrom django.utils.translation import gettext_lazy as _[m
[32m+[m
[32m+[m[32m# í´ë˜ìŠ¤ëª… ë‹¨ìˆ˜ë¡œ[m
[32m+[m[32m# ì´ë¦„ ë¶™ì´ëŠ” ê±°ëŠ” ë¶ˆë ¤ì˜¤ëŠ”ê³³ì—ì„œ ì´ë¦„ì´ ì–¼ë§ˆë‚˜ ìì—°ìŠ¤ëŸ¬ìš´ì§€ê°€ ì¤‘ìš”í•¨[m
[32m+[m[32mclass IndustryJob(models.Model):[m
[32m+[m[32m    class Status(models.TextChoices):[m
[32m+[m[32m        ACTIVE = 'active', _('Active'),[m
[32m+[m[32m        CANCELLED = 'cancelled', _('Cancelled'),[m
[32m+[m[32m        DELIVERED = 'delivered', _('Delivered'),[m
[32m+[m[32m        PAUSED = 'paused', _('Paused'),[m
[32m+[m[32m        READY = 'ready', _('Ready'),[m
[32m+[m[32m        REVERTED = 'reverted', _('Reverted')[m
[32m+[m
[32m+[m[32m    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="indsutry_jobs")[m
[32m+[m[32m    activity_id = models.IntegerField(null=True)[m
[32m+[m[32m    blueprint_id = models.BigIntegerField(null=True)[m
[32m+[m[32m    blueprint_location_id = models.BigIntegerField(null=True)[m
[32m+[m[32m    blueprint_type_id = models.BigIntegerField(null=True)[m
[32m+[m[32m    completed_character_id = models.IntegerField(null=True)[m
[32m+[m[32m    completed_data = models.DateTimeField(null=True)[m
[32m+[m[32m    cost = models.DecimalField(max_digits=13, decimal_places=4, null=True)[m
[32m+[m[32m    duration = models.IntegerField(null=True)[m
[32m+[m[32m    end_date = models.DateTimeField(null=True)[m
[32m+[m[32m    facility_id = models.BigIntegerField(null=True)[m
[32m+[m[32m    installer_id = models.IntegerField(null=True)[m
[32m+[m[32m    job_id = models.IntegerField(null=True)[m
[32m+[m[32m    licensed_runs = models.IntegerField(null=True)[m
[32m+[m[32m    output_location_id = models.BigIntegerField(null=True)[m
[32m+[m[32m    pause_date = models.DateTimeField(null=True)[m
[32m+[m[32m    probability = models.FloatField(null=True)[m
[32m+[m[32m    product_type_id = models.IntegerField(null=True)[m
[32m+[m[32m    runs = models.IntegerField(null=True)[m
[32m+[m[32m    start_date = models.DateTimeField(null=True)[m
[32m+[m[32m    station_id = models.BigIntegerField(null=True)[m
[32m+[m[32m    status = models.CharField([m
[32m+[m[32m        max_length=10,[m
[32m+[m[32m        choices=Status.choices[m
[32m+[m[32m    )[m
[32m+[m[32m    successful_runs = models.IntegerField(null=True)[m
[32m+[m
[32m+[m[32m   # class StatusInJobs(models.TextChoices):[m
[32m+[m[32m   #      ACTIVE = 'active', _('Active'),[m
[32m+[m[32m   #      CANCELLED = 'cancelled', _('Cancelled'),[m
[32m+[m[32m   #      DELIVERED = 'delivered', _('Delivered'),[m
[32m+[m[32m   #      PAUSED = 'paused', _('Paused'),[m
[32m+[m[32m   #      READY = 'ready', _('Ready'),[m
[32m+[m[32m   #      REVERTED = 'reverted', _('Reverted')[m
[32m+[m[32m   #[m
[32m+[m[32m   #  user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="indsutry_jobs")[m
[32m+[m[32m   #  activity_id = models.IntegerField()[m
[32m+[m[32m   #  blueprint_id = models.BigIntegerField()[m
[32m+[m[32m   #  blueprint_location_id = models.BigIntegerField()[m
[32m+[m[32m   #  blueprint_type_id = models.BigIntegerField()[m
[32m+[m[32m   #  completed_character_id = models.IntegerField()[m
[32m+[m[32m   #  completed_data = models.DateTimeField()[m
[32m+[m[32m   #  cost = models.DecimalField(max_digits=13, decimal_places=4)[m
[32m+[m[32m   #  duration = models.IntegerField()[m
[32m+[m[32m   #  end_date = models.DateTimeField()[m
[32m+[m[32m   #  facility_id = models.BigIntegerField()[m
[32m+[m[32m   #  installer_id = models.IntegerField()[m
[32m+[m[32m   #  job_id = models.IntegerField()[m
[32m+[m[32m   #  licensed_runs = models.IntegerField()[m
[32m+[m[32m   #  output_location_id = models.BigIntegerField()[m
[32m+[m[32m   #  pause_date = models.DateTimeField()[m
[32m+[m[32m   #  probability = models.IntegerField()[m
[32m+[m[32m   #  product_type_id = models.IntegerField()[m
[32m+[m[32m   #  runs = models.IntegerField()[m
[32m+[m[32m   #  start_date = models.DateTimeField()[m
[32m+[m[32m   #  station_id = models.BigIntegerField()[m
[32m+[m[32m   #  status = models.CharField([m
[32m+[m[32m   #      max_length=10,[m
[32m+[m[32m   #      choices=StatusInJobs.choices[m
[32m+[m[32m   #  )[m
[32m+[m[32m   #  successful_runs = models.IntegerField()[m
[32m+[m
[32m+[m
[1mdiff --git a/industry_alert/esi/serializers.py b/industry_alert/esi/serializers.py[m
[1mnew file mode 100644[m
[1mindex 0000000..ff1a29e[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/esi/serializers.py[m
[36m@@ -0,0 +1,94 @@[m
[32m+[m[32mfrom rest_framework import serializers[m
[32m+[m[32mfrom .models import IndustryJob[m
[32m+[m
[32m+[m[32m# atomic[m
[32m+[m[32mfrom django.db import transaction[m
[32m+[m
[32m+[m
[32m+[m[32mclass IndustryJobListSerializer(serializers.ListSerializer):[m
[32m+[m[32m    # https://wikidocs.net/21054[m
[32m+[m[32m    # ì´ê±°ë¥¼ ê·¸ëƒ¥ í•˜ë©´ ì´ í•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¬ë•Œë§ˆë‹¤ ìŠ¤íƒì— ì˜¬ë ¸ë‹¤ ë‚´ë ¸ë‹¤í•˜ë‹ˆ[m
[32m+[m[32m    # @staticmethodë¡œ í™ì— ì˜¬ë ¤ë²„ë¦¬ê¸°[m
[32m+[m[32m    # ì§€ê¸ˆì€ ì‘ì•„ì„œ ìƒê´€ì—†ëŠ”ë° ì»¤ì§€ë©´ ìœ ì˜ë¯¸í•´ì§[m
[32m+[m[32m    @staticmethod[m
[32m+[m[32m    def set_status(job, new_status):[m
[32m+[m[32m        job.status = new_status[m
[32m+[m[32m        return job[m
[32m+[m
[32m+[m[32m    # atomic allows us to create a block of code within which the atomicity on the database is guaranteed.[m
[32m+[m[32m    # ì´ í•¨ìˆ˜ëŠ” atomicí•˜ê²Œ transactionì²˜ë¦¬í•¨[m
[32m+[m[32m    # https://docs.djangoproject.com/en/3.2/topics/db/transactions/#order-of-execution[m
[32m+[m[32m    @transaction.atomic[m
[32m+[m[32m    def create(self, validated_data):[m
[32m+[m[32m        print("in serializer validated_data = ", validated_data)[m
[32m+[m
[32m+[m[32m        # ìœ ì €ì— ëŒ€í•´ì„œ ì €ì¥ëœ ì¡ì´ ìˆëŠ”ì§€ í™•ì¸[m
[32m+[m[32m        # filterì—ì„œëŠ” db hit ì•ˆí•¨[m
[32m+[m[32m        # ì´ê±° ì°ì–´ë³´ë©´ queryset ì˜¤ë¸Œì íŠ¸ ë‚˜ì˜¤ê³  í•˜ë‚˜ getí•˜ê¸°ì „ì—ëŠ” dbì—ì„œ ê°’ì„ ê°€ì ¸ì˜¤ì§€ ì•ŠìŒ[m
[32m+[m[32m        # https://docs.djangoproject.com/en/3.2/ref/models/querysets/[m
[32m+[m[32m        # evaluateí• ë•Œë§Œ dbë‘ í†µì‹ í•¨[m
[32m+[m[32m        instance = IndustryJob.objects.filter(user=validated_data[0]['user'])[m
[32m+[m[32m        # ìœ ì €ì— ëŒ€í•´ì„œ ì €ì¥ëœ ì¡ì´ ìˆìœ¼ë©´[m
[32m+[m[32m        if instance.exists():[m
[32m+[m[32m            # ê¸°ì¡´ì— ì¡´ì¬í•˜ëŠ” jobë“¤ì„ job_idë¥¼ keyë¡œ ì •ë¦¬[m
[32m+[m[32m            # ì—¬ê¸°ì„œ iterateí•˜ë‹ˆ  db hit í•˜ëŠ”ê±°ì„[m
[32m+[m[32m            job_mapping = {job.job_id: job for job in instance}[m
[32m+[m[32m            # ìƒˆë¡œ ë°›ì•„ì˜¨ jobë“¤ì„ job_idë¥¼ í‚¤ë¡œ ì •ë¦¬[m
[32m+[m[32m            data_mapping = {item['job_id']: item for item in validated_data}[m
[32m+[m
[32m+[m[32m            # ìƒˆë¡œ ë°›ì•„ì˜¨ jobì´ dbì— ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ìƒì„±[m
[32m+[m[32m            need_create = [[m
[32m+[m[32m                IndustryJob(**data) for job_id, data in data_mapping.items() if job_mapping.get(job_id) is None[m
[32m+[m[32m            ][m
[32m+[m[32m            # ì´ê±° []ë“¤ì–´ê°€ë©´ ì‹¤í–‰ì•ˆí•˜ê³  ëë‚˜ì„œ if need_crate: ì´ë ‡ê²Œ ì•ˆí•´ë„ë¨[m
[32m+[m[32m            IndustryJob.objects.bulk_create(need_create)[m
[32m+[m
[32m+[m[32m            # ìƒˆë¡œ ë°›ì•„ì˜¨ jobì´ dbì— ì €ì¥ë˜ì–´ ìˆê³  statusê°€ ë³€ê²½ ëìœ¼ë©´ update í•´ì¤Œ[m
[32m+[m[32m            # ì´ê±° staticmethodëŠ” ë¶ˆëŸ¬ì˜¬ë•Œ í¬ë˜ìŠ¤ëª…[m
[32m+[m[32m            need_update = [[m
[32m+[m[32m                IndustryJobListSerializer.set_status(job, data_mapping[job_id]['status']) for job_id, job in job_mapping.items()[m
[32m+[m[32m                if job_id in data_mapping.keys() and job.status != data_mapping[job_id]['status'][m
[32m+[m[32m            ][m
[32m+[m[32m            IndustryJob.objects.bulk_update(need_update, ['status'])[m
[32m+[m
[32m+[m[32m            # ì´ë¯¸ ìˆëŠ” ì¡ì´ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¨ jobì— ì—†ìœ¼ë©´ ì™„ë£Œë˜ì„œ ì‚¬ë¼ì§„ê±°ë‹ˆ ì‚­ì œí•´ì¤Œ[m
[32m+[m[32m            # ì´ê±° python gcê°€ referenceê¸°ë°˜ì´ì–´ì„œ ì•„ë˜ì—ì„œ ë”ì´ìƒ ì•ˆì“°ë©´ ì•Œì•„ì„œ ì§€ì›Œì¤Œ[m
[32m+[m[32m            # ì•„ë˜ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ë©´ì„œ job.delete() ì‹¤í–‰í•˜ê³  ë‹¤ìŒì¤„ ë‚´ë ¤ê°€ë©´ì„œ ë©”ëª¨ë¦¬ì—ì„œ ë‚ ì•„ê°[m
[32m+[m[32m            [job.delete() for job_id, job in job_mapping.items() if job_id not in data_mapping][m
[32m+[m
[32m+[m[32m            # bulk_create, bulk_updateì˜ ë¦¬í„´ê°’ì„ ë„˜ê²¨ì£¼ì§€ë§ê³  ê·¸ëƒ¥ ì´ë ‡ê²Œ í•´ë„ë¨[m
[32m+[m[32m            # ì‹¤ì œë¡œ ìƒì„±ëœ ê²ƒë„ ì•„ë‹ˆë‹ˆê¹Œ ìƒì„±ì „ ë°ì´í„°ë§Œ ë„£ì–´ì£¼ê¸°[m
[32m+[m[32m            ret = [*need_create, *need_update][m
[32m+[m[32m            if ret:[m
[32m+[m[32m                return ret[m
[32m+[m[32m            return validated_data[m
[32m+[m
[32m+[m[32m        # ìœ ì €ì— ëŒ€í•´ì„œ ì¡ì´ ì—†ìœ¼ë©´ create[m
[32m+[m[32m        industry_jobs = [IndustryJob(**item) for item in validated_data][m
[32m+[m[32m        return IndustryJob.objects.bulk_create(industry_jobs)[m
[32m+[m
[32m+[m[32mclass IndustryJobSerializer(serializers.ModelSerializer):[m
[32m+[m[32m    # ì´ê±° id ê¸°ë³¸ìœ¼ë¡œëŠ” read_onlyì—¬ê°€ì§€ê³  ì´ë ‡ê²Œ í•´ì¤˜ì•¼í•¨[m
[32m+[m[32m    # id = serializers.IntegerField()[m
[32m+[m[32m    completed_character_id = serializers.IntegerField(required=False)[m
[32m+[m[32m    completed_date = serializers.DateTimeField(required=False)[m
[32m+[m[32m    cost = serializers.DecimalField(max_digits=13, decimal_places=4, required=False)[m
[32m+[m[32m    licensed_runs = serializers.IntegerField(required=False)[m
[32m+[m[32m    pause_date = serializers.DateTimeField(required=False)[m
[32m+[m[32m    probability = serializers.FloatField(required=False)[m
[32m+[m[32m    product_type_id = serializers.IntegerField(required=False)[m
[32m+[m[32m    successful_runs = serializers.IntegerField(required=False)[m
[32m+[m
[32m+[m[32m    class Meta:[m
[32m+[m[32m        list_serializer_class = IndustryJobListSerializer[m
[32m+[m[32m        model = IndustryJob[m
[32m+[m[32m        # ì´ê±° contextë¡œ userë„£ì–´ì¤„ê±°ë¼ì„œ userì¼ë‹¨ fieldsì—ì„œ ëºŒ[m
[32m+[m[32m        fields = ['id', 'activity_id', 'blueprint_id', 'blueprint_location_id', 'blueprint_type_id',[m
[32m+[m[32m                  'completed_character_id', 'completed_date', 'cost',[m
[32m+[m[32m                  'duration', 'end_date', 'facility_id', 'installer_id', 'job_id', 'licensed_runs', 'output_location_id',[m
[32m+[m[32m                  'pause_date', 'probability', 'product_type_id', 'runs', 'start_date', 'station_id', 'status',[m
[32m+[m[32m                  'successful_runs'][m
[32m+[m
[32m+[m[32m    def validate(self, attr):[m
[32m+[m[32m        attr['user'] = self.context['user'][m
[32m+[m[32m        return attr[m
\ No newline at end of file[m
[1mdiff --git a/industry_alert/esi/tests.py b/industry_alert/esi/tests.py[m
[1mnew file mode 100644[m
[1mindex 0000000..7ce503c[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/esi/tests.py[m
[36m@@ -0,0 +1,3 @@[m
[32m+[m[32mfrom django.test import TestCase[m
[32m+[m
[32m+[m[32m# Create your tests here.[m
[1mdiff --git a/industry_alert/esi/urls.py b/industry_alert/esi/urls.py[m
[1mnew file mode 100644[m
[1mindex 0000000..c0b128a[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/esi/urls.py[m
[36m@@ -0,0 +1,14 @@[m
[32m+[m[32mfrom django.urls import path[m
[32m+[m[32mfrom django.urls import include # re_pathìš©[m
[32m+[m[32m#  blog ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•  ëª¨ë“  viewsë¥¼ ê°€ì ¸ì™”ì–´ìš”[m
[32m+[m[32mfrom . import views[m
[32m+[m
[32m+[m[32m# drf[m
[32m+[m[32mfrom rest_framework.routers import DefaultRouter[m
[32m+[m
[32m+[m[32mrouter = DefaultRouter(trailing_slash=False)[m
[32m+[m[32mrouter.register(r'industry/jobs', views.IndustryJobViewSet, basename='industry_jobs')[m
[32m+[m
[32m+[m[32murlpatterns = [[m
[32m+[m[32m    path('api/v1/', include(router.urls)),[m
[32m+[m[32m][m
[1mdiff --git a/industry_alert/esi/views.py b/industry_alert/esi/views.py[m
[1mnew file mode 100644[m
[1mindex 0000000..81d7e8e[m
[1m--- /dev/null[m
[1m+++ b/industry_alert/esi/views.py[m
[36m@@ -0,0 +1,96 @@[m
[32m+[m[32mfrom django.shortcuts import render, get_object_or_404[m
[32m+[m[32mfrom django.utils import timezone # timezone.now() ì‚¬ìš©í•˜ê¸° ìœ„í•¨ì„[m
[32m+[m
[32m+[m[32mfrom .models import IndustryJob[m
[32m+[m[32mfrom .serializers import IndustryJobSerializer[m
[32m+[m
[32m+[m[32m# ì—¬ê¸°ë¶€í„° drf viewset ì ìš©ìœ„í•œê±°ì„[m
[32m+[m[32mfrom rest_framework import viewsets, serializers, status[m
[32m+[m[32mfrom rest_framework.decorators import action[m
[32m+[m[32mfrom rest_framework.response import Response[m
[32m+[m
[32m+[m
[32m+[m[32mclass IndustryJobViewSet(viewsets.GenericViewSet):[m
[32m+[m[32m    queryset = IndustryJob.objects.all()[m
[32m+[m[32m    serializer_class = IndustryJobSerializer[m
[32m+[m
[32m+[m[32m    # http GET http://127.0.0.1:8000/api/v1/post "Authorization: Token 65b51c4fbf5914eda00efdeb7828842dd0d4dcc6"[m
[32m+[m[32m    def list(self, request):[m
[32m+[m[32m        queryset = self.get_queryset()[m
[32m+[m[32m        serializer = self.get_serializer(queryset, many=True)[m
[32m+[m[32m        return Response(serializer.data)[m
[32m+[m
[32m+[m[32m    # http GET http://127.0.0.1:8000/api/v1/post/<int:pk>[m
[32m+[m[32m    def retrieve(self, request, pk):[m
[32m+[m[32m        instance = self.get_object()[m
[32m+[m[32m        serializer = self.get_serializer(instance)[m
[32m+[m[32m        return Response(serializer.data)[m
[32m+[m
[32m+[m[32m    # http GET http://127.0.0.1:8000/api/v1/post/published "Authorization: Token 65b51c4fbf5914eda00efdeb7828842dd0d4dcc6"[m
[32m+[m[32m    # ì´ê±° /api/v1/post/publishedë¡œ ë“±ë¡ë¨[m
[32m+[m[32m    # ê·¸ë¦¬ê³  ì´ì „ì— í–ˆë˜ ê²ƒ ì²˜ëŸ¼ cur_user = UserSerializer(request.user) ì´ë ‡ê²Œ ì‹œë¦¬ì–¼ë¼ì´ì ¸ íƒˆ í•„ìš”ì—†ìŒ[m
[32m+[m[32m    # ì™œëƒë©´ request.userê°€ ì‹¤ì œ User ì¸ìŠ¤í„´ìŠ¤ë¼ì„œ ê± ë°”ë¡œ ë„£ì–´ë„ ë¨[m
[32m+[m[32m    @action(methods=['get'], detail=False, url_path='users_jobs')[m
[32m+[m[32m    def get_users_industry_jobs(self, request):[m
[32m+[m[32m        queryset = self.get_queryset().filter(user=request.user)[m
[32m+[m[32m        serializer = self.get_serializer(queryset, many=True)[m
[32m+[m[